"use strict";exports.id=129,exports.ids=[129],exports.modules={81129:(e,t,i)=>{i.d(t,{y0:()=>ef,ap:()=>ee,xS:()=>eS,zX:()=>eh,hC:()=>ey,BU:()=>eo});var n=i(24263),r=i(72019),a=i(21925),s=i(43895);let o=process.env.GAMMA_API_URL||"https://gamma-api.polymarket.com";async function l(e){try{let t=(await n.Z.get(`${o}/markets`,{params:{slug:e},timeout:1e4})).data;if(!t||!Array.isArray(t)||0===t.length)return s.k.debug(`No market found for slug: ${e}`),null;let i=t[0],r=i.clobTokenIds?"string"==typeof i.clobTokenIds?JSON.parse(i.clobTokenIds):i.clobTokenIds:[];if(r.length<2)return s.k.warn(`Market ${e} has insufficient token IDs`),null;return{conditionId:i.conditionId,slug:i.slug||e,question:i.question||"BTC 15m candle",yesTokenId:r[0],noTokenId:r[1],endDate:i.endDate||i.endDateIso||"",endTimestamp:i.endDate?new Date(i.endDate).getTime()/1e3:0,active:!1!==i.active&&!i.closed,tickSize:i.orderPriceMinTickSize||"0.01",negRisk:!0===i.negRisk}}catch(t){if(n.Z.isAxiosError(t)&&t.response?.status===404)return null;return s.k.error(`Error fetching market ${e}: ${t}`),null}}async function d(){let e=function(){let e=Math.floor(Date.now()/1e3);return`btc-updown-15m-${900*Math.floor(e/900)}`}(),t=await l(e);if(t&&t.active)return t;let i=Math.floor(Date.now()/1e3),n=`btc-updown-15m-${(Math.floor(i/900)-1)*900}`;return(t=await l(n))&&t.active?t:null}async function c(e){try{let t=(0,a.YX)(),[i,n]=await Promise.all([t.getOrderBook(e.yesTokenId).catch(()=>null),t.getOrderBook(e.noTokenId).catch(()=>null)]),r=.5,s=.5;i&&(i.asks&&i.asks.length>0?r=parseFloat(i.asks[0].price):i.last_trade_price&&(r=parseFloat(i.last_trade_price))),n&&(n.asks&&n.asks.length>0?s=parseFloat(n.asks[0].price):n.last_trade_price&&(s=parseFloat(n.last_trade_price))),r>0&&.5===s?s=Math.max(.01,1-r):s>0&&.5===r&&(r=Math.max(.01,1-s));let o=r>=s?"yes":"no",l="yes"===o?r:s;return{yesPrice:r,noPrice:s,leadingSide:o,leadingPrice:l,timestamp:Date.now()}}catch(e){return s.k.error(`Error fetching prices: ${e}`),null}}async function u(e){try{let t=(await n.Z.get(`${o}/markets`,{params:{slug:e},timeout:1e4})).data;if(!t||!Array.isArray(t)||0===t.length)return s.k.debug(`[Resolution] No market found for slug: ${e}`),null;let i=t[0];if(!0===i.active&&!i.closed)return s.k.debug(`[Resolution] ${e} still active (active=${i.active}, closed=${i.closed})`),null;if(i.outcomePrices){let t;if("string"==typeof i.outcomePrices)try{let e=JSON.parse(i.outcomePrices);t=Array.isArray(e)?e.map(Number):i.outcomePrices.split(",").map(Number)}catch{t=i.outcomePrices.split(",").map(Number)}else{if(!Array.isArray(i.outcomePrices))return s.k.debug(`[Resolution] ${e} unexpected outcomePrices type: ${typeof i.outcomePrices}`),null;t=i.outcomePrices.map(Number)}if(t.length>=2&&!t.some(isNaN)){if(t[0]>t[1])return s.k.info(`[Resolution] ${e} resolved YES/UP (prices: ${t})`),"yes";if(t[1]>t[0])return s.k.info(`[Resolution] ${e} resolved NO/DOWN (prices: ${t})`),"no"}s.k.debug(`[Resolution] ${e} outcomePrices inconclusive: ${JSON.stringify(t)}`)}else s.k.debug(`[Resolution] ${e} closed but no outcomePrices (active=${i.active}, closed=${i.closed})`);return null}catch(t){return s.k.error(`[Resolution] Failed to fetch ${e}: ${t}`),null}}async function p(e){try{let t=(0,a.YX)(),i=await t.getMidpoints([{token_id:e.yesTokenId,side:r.MF.BUY},{token_id:e.noTokenId,side:r.MF.BUY}]),n=parseFloat(i?.[e.yesTokenId]||"0"),o=parseFloat(i?.[e.noTokenId]||"0");if(s.k.debug(`[Resolution CLOB] ${e.slug} YES=${n} NO=${o}`),n>.9)return"yes";if(o>.9)return"no";return null}catch(t){return s.k.debug(`[Resolution CLOB] Failed for ${e.slug}: ${t}`),null}}async function g(e){try{let t=(0,a.YX)(),i=await t.getMidpoints([{token_id:e.yesTokenId,side:r.MF.BUY},{token_id:e.noTokenId,side:r.MF.BUY}]),n=parseFloat(i?.[e.yesTokenId]||"0.5"),s=parseFloat(i?.[e.noTokenId]||"0.5"),o=n>=s?"yes":"no";return{yesPrice:n,noPrice:s,leadingSide:o,leadingPrice:"yes"===o?n:s,timestamp:Date.now()}}catch{return c(e)}}var f=i(3412);function $(e,t){let i=t*(1-t);return .25*e*i*i}async function m(e,t,i,n,r,o,l={}){let d=n/i,c="yes"===t?e.yesTokenId:e.noTokenId,u=$(d,i),p=l.expectedPrice?Math.abs(i-l.expectedPrice)/l.expectedPrice:0;if(r)return s.k.info(`[PAPER] BUY ${d.toFixed(4)} ${t} @ $${i.toFixed(4)} ($${n}) | Asset: ${l.asset||"?"} | Strategy: ${l.subStrategy||"?"} | Fee: $${u.toFixed(6)}`),{trade:(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t,action:"buy",price:i,amount:n,shares:d,pnl:null,paper:!0,orderId:null,asset:l.asset||null,subStrategy:l.subStrategy||null,binancePriceAtEntry:null,slippage:p,takerFee:u})};s.k.info(`[LIVE] Placing BUY: ${d.toFixed(4)} ${t} @ $${i.toFixed(4)}`);let g=await (0,a.L4)(c,i,d,e.tickSize,e.negRisk);return g.success?{trade:(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t,action:"buy",price:i,amount:n,shares:d,pnl:null,paper:!1,orderId:g.orderId||null,asset:l.asset||null,subStrategy:l.subStrategy||null,binancePriceAtEntry:null,slippage:p,takerFee:u})}:(s.k.error(`Buy order failed: ${g.error}`),{trade:null,error:g.error})}async function h(e,t,i,n,r={}){let o="yes"===t.side?e.yesTokenId:e.noTokenId,l=t.shares*i,d=l-t.costBasis,c=$(t.shares,i);if(n)return s.k.info(`[PAPER] SELL ${t.shares.toFixed(4)} ${t.side} @ $${i.toFixed(4)} | P&L: $${d.toFixed(4)}`),{trade:(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t.side,action:"sell",price:i,amount:l,shares:t.shares,pnl:d,paper:!0,orderId:null,asset:r.asset||null,subStrategy:r.subStrategy||null,binancePriceAtEntry:null,slippage:null,takerFee:c})};s.k.info(`[LIVE] Placing SELL: ${t.shares.toFixed(4)} ${t.side} @ $${i.toFixed(4)}`);let u=await (0,a.EG)(o,i,t.shares,e.tickSize,e.negRisk);return u.success?{trade:(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t.side,action:"sell",price:i,amount:l,shares:t.shares,pnl:d,paper:!1,orderId:u.orderId||null,asset:r.asset||null,subStrategy:r.subStrategy||null,binancePriceAtEntry:null,slippage:null,takerFee:c})}:(s.k.error(`Sell order failed: ${u.error}`),{trade:null,error:u.error})}let y=null,S={windowsPlayed:0,bothSidesFilled:0,oneSideFilled:0,neitherFilled:0,totalPnl:0,avgProfitPerWindow:0},P=null,k=0,w=30,I=()=>{},b=()=>{},x=()=>{};async function F(e,t,i){if(!e.arbEnabled)return;let n=t.find(t=>t.asset===e.arbMarket);if(!n)return;let r=Math.floor(Date.now()/1e3),a=900*Math.floor(r/900),s=`${e.arbMarket.toLowerCase()}-arb-${a}`,o=a+900-r;if(y&&y.windowId!==s&&(await C(y,i),y=null,P=null),y&&o<=e.arbCancelBeforeEnd&&"active"===y.status&&(await E(y,i),y.status="cancelling",b(`[ARB] Cancelled unfilled orders -- ${o}s before resolution`)),!(o<=e.arbCancelBeforeEnd)){if(P===s){i&&y&&"active"===y.status&&function(e,t){let i=t.yesPrice,n=t.noPrice,r=!1;for(let t of e.upSide.orders)if(("placed"===t.status||"partial"===t.status)&&i<=t.price+.02){let e=i<=t.price?1:.3,n=t.targetSize*e;n>t.filledSize&&(t.filledSize=n,t.status=t.filledSize>=t.targetSize?"filled":"partial",r=!0)}for(let t of e.downSide.orders)if(("placed"===t.status||"partial"===t.status)&&n<=t.price+.02){let e=n<=t.price?1:.3,i=t.targetSize*e;i>t.filledSize&&(t.filledSize=i,t.status=t.filledSize>=t.targetSize?"filled":"partial",r=!0)}r&&(M(e.upSide),M(e.downSide),v())}(y,n);return}if(w<e.arbMaxPerWindow)return;await B(e,n,s,a,i)}}async function B(e,t,i,n,r){let o=null!=e.arbBudgetUp&&e.arbBudgetUp>0?e.arbBudgetUp:e.arbMaxPerWindow/2,l=null!=e.arbBudgetDown&&e.arbBudgetDown>0?e.arbBudgetDown:e.arbMaxPerWindow/2,d=[],c=[];for(let u of e.arbLadderLevels){let e=o*u.allocation,p=l*u.allocation,g=e/u.price,f=p/u.price,$={side:"yes",price:u.price,targetSize:g,filledSize:0,orderId:null,status:"pending"},m={side:"no",price:u.price,targetSize:f,filledSize:0,orderId:null,status:"pending"};if(r)$.orderId=`paper-up-${u.price}-${n}`,$.status="placed",m.orderId=`paper-down-${u.price}-${n}`,m.status="placed";else{let e=await (0,a.pQ)(t.yesTokenId,u.price,g,t.tickSize,t.negRisk);e.success&&e.orderId&&($.orderId=e.orderId,$.status="placed");let i=await (0,a.pQ)(t.noTokenId,u.price,f,t.tickSize,t.negRisk);i.success&&i.orderId&&(m.orderId=i.orderId,m.status="placed")}d.push($),c.push(m),s.k.info(`[ARB] Limit order: UP $${u.price} x ${g.toFixed(2)} shares | DOWN $${u.price} x ${f.toFixed(2)} shares | window=${i}`)}w-=e.arbMaxPerWindow,k=e.arbMaxPerWindow,y={windowId:i,conditionId:t.conditionId,slug:t.slug,asset:e.arbMarket,startTime:n,endTime:n+900,secondsRemaining:n+900-Math.floor(Date.now()/1e3),upSide:{totalShares:0,totalCost:0,avgPrice:0,orders:d},downSide:{totalShares:0,totalCost:0,avgPrice:0,orders:c},combinedCost:0,guaranteedPnl:0,status:"active",resolution:"pending",pnl:null},P=i,S.windowsPlayed++,b(`[ARB] Placed ${2*e.arbLadderLevels.length} limit orders for ${i}`),x("info",`Arb: Placed ladder orders for ${e.arbMarket}`,e.arbMarket)}function M(e){let t=0,i=0;for(let n of e.orders)t+=n.filledSize,i+=n.filledSize*n.price;e.totalShares=t,e.totalCost=i,e.avgPrice=t>0?i/t:0}function v(){if(!y)return;let e=y.upSide,t=y.downSide;if(e.avgPrice>0&&t.avgPrice>0){y.combinedCost=e.avgPrice+t.avgPrice;let i=Math.min(e.totalShares,t.totalShares);y.guaranteedPnl=i*(1-y.combinedCost)}else e.avgPrice>0||t.avgPrice>0?y.combinedCost=e.avgPrice+t.avgPrice:y.combinedCost=0,y.guaranteedPnl=0}async function E(e,t){let i=[];for(let n of[...e.upSide.orders,...e.downSide.orders])("placed"===n.status||"partial"===n.status)&&n.orderId&&(t||i.push(n.orderId),n.status="cancelled");i.length>0&&!t&&await (0,a._e)(i),M(e.upSide),M(e.downSide),v(),s.k.info(`[ARB] Cancelled ${i.length} unfilled orders | UP: ${e.upSide.totalShares.toFixed(2)} shares | DOWN: ${e.downSide.totalShares.toFixed(2)} shares | Combined: $${e.combinedCost.toFixed(3)}`)}async function C(e,t){"active"===e.status&&await E(e,t),e.status="resolved";let i=e.upSide.totalShares,n=e.downSide.totalShares,r=e.upSide.totalCost,a=e.downSide.totalCost,o=r+a,l=i>0&&n>0,d=i>0!=n>0;if(l?S.bothSidesFilled++:d?S.oneSideFilled++:S.neitherFilled++,0===o){w=Math.min(30,w+k),b(`[ARB] Window ${e.windowId} -- no fills, capital returned`);return}if(i>0){let n=(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"yes",action:"buy",price:e.upSide.avgPrice,amount:r,shares:i,pnl:null,paper:t,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:0});I(n)}if(n>0){let i=(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"no",action:"buy",price:e.downSide.avgPrice,amount:a,shares:n,pnl:null,paper:t,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:0});I(i)}if(t&&o>0){let t=Math.random()>.5,s=t?1*i:0,l=t?0:1*n,d=s+l,c=d-o;if(e.resolution=t?"up":"down",e.pnl=c,i>0){let n=(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"yes",action:"resolution",price:t?1:0,amount:s,shares:i,pnl:s-r,paper:!0,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:null});I(n)}if(n>0){let i=(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"no",action:"resolution",price:t?0:1,amount:l,shares:n,pnl:l-a,paper:!0,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:null});I(i)}S.totalPnl+=c,S.bothSidesFilled+S.oneSideFilled>0&&(S.avgProfitPerWindow=S.totalPnl/(S.bothSidesFilled+S.oneSideFilled)),w=Math.min(30,w+d),b(`[ARB] ${c>=0?"WIN":"LOSS"} Window resolved ${t?"UP":"DOWN"} | Invested: $${o.toFixed(2)} | Payout: $${d.toFixed(2)} | P&L: $${c.toFixed(2)}`),x(c>=0?"success":"warning",`Arb ${t?"UP":"DOWN"}: P&L $${c.toFixed(2)} (invested $${o.toFixed(2)})`,e.asset)}else w=Math.min(30,w+o);s.k.info(`[ARB] Window summary: ${e.windowId} | UP: ${i.toFixed(2)} @ $${e.upSide.avgPrice.toFixed(3)} | DOWN: ${n.toFixed(2)} @ $${e.downSide.avgPrice.toFixed(3)} | Combined: $${e.combinedCost.toFixed(3)} | P&L: ${null!==e.pnl?"$"+e.pnl.toFixed(2):"pending"}`)}var D=i(24979);let T="stopped",O="disconnected",A="Idle",L=null,R=null,z=null,N=null,W=new Map,U=new Map,_=new Map,Y=!1,J=null,V=null,X=[],G=0,Z=null,j=null,q=null,H=null,Q=0;function K(){let e=Date.now();return(!H||e-Q>5e3)&&(H=(0,f.Gw)(),Q=e),H}function ee(){H=null,Q=0}let et=!1,ei={},en=new Set,er=!1;function ea(){if(er)return;er=!0;let e=K();(0,D.up)(e.enabledAssets),s.k.info("[Engine] Auto-started market scanner for dashboard")}let es="";function eo(e){return ea(),q||(q=setInterval(()=>{if(0===en.size)return;let e=K(),t={};for(let e of(0,D.$2)())t[e.asset]=e;let i=(0,D.bp)(e.enabledAssets),n=JSON.stringify(i),r=n!==es;r&&(es=n),el({type:"price",data:{markets:t,...r?{recentOutcomes:i}:{}},timestamp:new Date().toISOString()})},2e3)),en.add(e),e({type:"state",data:ef(),timestamp:new Date().toISOString()}),()=>en.delete(e)}function el(e){for(let t of en)try{t(e)}catch{en.delete(t)}}function ed(){el({type:"state",data:ef(),timestamp:new Date().toISOString()})}function ec(e){el({type:"trade",data:e,timestamp:new Date().toISOString()})}function eu(e){el({type:"log",data:{message:e},timestamp:new Date().toISOString()})}function ep(e,t,i){let n={id:`alert-${++G}`,timestamp:new Date().toISOString(),severity:e,message:t,asset:i};X.unshift(n),X.length>100&&(X.length=100),el({type:"alert",data:n,timestamp:n.timestamp})}function eg(e){let t=0;for(let e of W.values())t+=e.costBasis;t+=y?y.upSide.totalCost+y.downSide.totalCost:0;let i=(0,f._l)(),n=(0,f.uF)(),r=(0,f.vs)();return{totalBankroll:e.totalBankroll,deployed:t,available:Math.max(0,e.maxTotalExposure-t),maxExposure:e.maxTotalExposure,todayPnl:i,winStreak:r,totalLosses:n}}function ef(){let e;let t=K(),i=function(){let e=Math.floor(Date.now()/1e3);return(Math.floor(e/900)+1)*900-e}(),n=!1;R?z?i>t.highConfTimeMax?e=`${(i/60).toFixed(1)}m remaining (need <= ${Math.floor(t.highConfTimeMax/60)}m)`:z.leadingPrice<t.highConfEntryMin||z.leadingPrice>t.highConfEntryMax?e=`Price $${z.leadingPrice.toFixed(4)} outside range $${t.highConfEntryMin}-$${t.highConfEntryMax}`:n=!0:e="Waiting for price data":e="No active market found";let r={market:R,prices:z,secondsRemaining:i,eligible:n,ineligibleReason:e},a={};for(let e of(0,D.$2)())a[e.asset]=e;let s={};for(let[e,t]of W)s[e]=t;return{status:T,connection:O,lastAction:A,lastActionTime:L,currentMarket:r,currentPosition:N,settings:t,cumulativePnl:(0,f.NW)(),totalTrades:(0,f.yW)(),activeMarkets:a,positions:s,capital:eg(t),circuitBreaker:{triggered:Y,reason:J,resumeAt:V,dailyPnl:(0,f._l)(),totalLosses:(0,f.uF)()},clobReady:et,alerts:X.slice(0,50),arbState:function(){if(!y)return null;let e=Math.floor(Date.now()/1e3);return y.secondsRemaining=Math.max(0,y.endTime-e),v(),{...y}}(),arbStats:{...S}}}async function e$(){try{O="connecting";let e=await d();if(e){R&&R.conditionId!==e.conditionId&&s.k.info(`Market rotated: ${R.slug} -> ${e.slug}`),R=e,U.set(e.conditionId,e),O="connected";let t=await g(e);t&&(z=t,N&&(N.currentPrice="yes"===N.side?t.yesPrice:t.noPrice,N.unrealizedPnl=N.shares*N.currentPrice-N.costBasis))}else R=null,z=null,O="connected"}catch(t){O="disconnected";let e=[t?.message?`message=${t.message}`:null,t?.code?`code=${t.code}`:null,t?.name?`name=${t.name}`:null,t?.response?.status?`status=${t.response.status}`:null,t?.config?.url?`url=${t.config.url}`:null].filter(Boolean).join(" ");s.k.error(`Market refresh failed${e?` (${e})`:""}`),eu(`Connection error${e?`: ${e}`:""}`)}ed()}async function em(){if("running"===T){try{let e=K();if(function(e){if(Y){if(V){let e=new Date(V).getTime();if(Date.now()>=e)return Y=!1,J=null,V=null,ep("info","Circuit breaker cooldown ended. Bot resumed."),!1}return!0}let t=(0,f._l)();if(t<-e.dailyLossLimit)return Y=!0,J=`Daily loss $${Math.abs(t).toFixed(2)} exceeded limit $${e.dailyLossLimit}`,V=new Date(Date.now()+144e5).toISOString(),ep("error",`Circuit breaker triggered: ${J}. Pausing for 4 hours.`),!0;let i=(0,f.uF)();return i>=e.lossLimit&&(Y=!0,J=`${i} losses today (limit: ${e.lossLimit})`,ep("error",`Circuit breaker triggered: ${J}. Bot stopped.`),!0)}(e)){ed();return}let t=(0,D.$2)();if(0===t.length){let e=Date.now(),t=ei._noMarkets;(!t||e-t.time>=15e3)&&(ei._noMarkets={reason:"no markets",time:e},eu("Scanning for active 15-minute markets..."))}for(let i of t){if(!e.enabledAssets.includes(i.asset))continue;let t=`${i.asset}-${i.conditionId}`,n=W.get(t)||null;if(!n&&W.size>=e.maxSimultaneousPositions)continue;let r=function(e,t,i,n){let r=t.secondsRemaining,a=t.yesPrice,s=t.noPrice;if(!e.highConfEnabled)return{action:"wait",reason:"High-confidence strategy disabled"};let o=a>=s?"yes":"no",l="yes"===o?a:s;if(n&&n.shares>0){if(r>=e.highConfTimeMin&&r<=e.highConfTimeMax&&l>=e.highConfEntryMin&&l<=e.highConfEntryMax&&o===n.side){let i=Date.now(),r=1e3*e.highConfBuyInterval;if(!n.lastBuyTime||i-n.lastBuyTime>=r)return{action:"buy",reason:`DCA: ${t.asset} ${n.side.toUpperCase()} @ $${l.toFixed(4)} � every ${e.highConfBuyInterval}s � $${n.costBasis.toFixed(2)} deployed`,side:n.side,price:l}}return{action:"hold",reason:`Holding ${n.side.toUpperCase()} @ $${n.avgEntryPrice.toFixed(4)} � ${n.shares.toFixed(2)} shares � $${n.costBasis.toFixed(2)}`}}return r<e.highConfTimeMin?{action:"wait",reason:`Window closing in ${r}s � no new entries`}:r>e.highConfTimeMax?{action:"wait",reason:`${t.asset}: ${Math.floor(r/60)}m left � waiting for ?${Math.floor(e.highConfTimeMax/60)}m`}:l>=e.highConfEntryMin&&l<=e.highConfEntryMax?{action:"buy",reason:`Entry: ${t.asset} ${o.toUpperCase()} @ $${l.toFixed(4)} (${Math.floor(r/60)}m left)`,side:o,price:l}:{action:"wait",reason:`${t.asset}: $${l.toFixed(4)} outside range $${e.highConfEntryMin}�$${e.highConfEntryMax}`}}(e,i,0,n);switch(r.action){case"buy":{if(!r.side||!r.price)break;let a=n?n.side:r.side,s="yes"===a?i.yesPrice:i.noPrice,o=e.highConfBuyAmount,l=Math.max(0,e.maxTotalExposure-eg(e).deployed);if((o=Math.min(o,e.perWindowMax-(n?.costBasis??0),l))<=0||n&&n.costBasis>=e.perWindowMax)break;let{trade:d,error:c}=await m(i.market,a,s,o,e.paperTrading,n?{conditionId:n.marketId,side:n.side,shares:n.shares,avgEntryPrice:n.avgEntryPrice,costBasis:n.costBasis,currentPrice:n.currentPrice,unrealizedPnl:n.unrealizedPnl}:null,{asset:i.asset,subStrategy:"highConfidence",expectedPrice:s});d?(n?(n.shares+=d.shares,n.costBasis+=d.amount,n.avgEntryPrice=n.costBasis/n.shares,n.lastBuyTime=Date.now()):(W.set(t,{marketId:i.conditionId,slug:i.slug,asset:i.asset,side:a,shares:d.shares,avgEntryPrice:s,currentPrice:s,unrealizedPnl:0,entryTime:new Date().toISOString(),hedged:!1,costBasis:d.amount,subStrategy:"highConfidence",lastBuyTime:Date.now()}),U.set(i.conditionId,i.market),"BTC"===i.asset&&(N={conditionId:i.conditionId,side:a,shares:d.shares,avgEntryPrice:s,costBasis:d.amount,currentPrice:s,unrealizedPnl:0})),A=`Buy ${i.asset} ${a} @ $${s.toFixed(4)}`,L=new Date().toISOString(),ec(d),ep("info",`Buy: ${i.asset} ${a.toUpperCase()} @ $${s.toFixed(4)}`,i.asset)):c&&eu(`Buy failed (${i.asset}): ${c}`),eu(r.reason);break}case"sell":{if(!n||!r.price||!r.side)break;let{trade:a,error:s}=await h(i.market,{conditionId:n.marketId,side:n.side,shares:n.shares,avgEntryPrice:n.avgEntryPrice,costBasis:n.costBasis,currentPrice:n.currentPrice,unrealizedPnl:n.unrealizedPnl},r.price,e.paperTrading,{asset:i.asset});a?(A=`Sold ${i.asset} ${n.side} @ $${r.price.toFixed(4)}`,L=new Date().toISOString(),W.delete(t),"BTC"===i.asset&&(N=null),ec(a),ep("warning",`Sold: ${i.asset} @ $${r.price.toFixed(4)} | P&L: $${a.pnl?.toFixed(4)}`,i.asset)):s&&eu(`Sell failed (${i.asset}): ${s}`),eu(r.reason);break}case"hold":case"wait":{let e=Date.now(),t=ei[i.asset],n=!t||t.reason!==r.reason,a=!t||e-t.time>=15e3;(n||a)&&(ei[i.asset]={reason:r.reason,time:e},eu(r.reason))}}}try{await F(e,t,e.paperTrading)}catch(e){s.k.error(`[ARB] Tick error: ${e}`)}for(let[t,i]of Array.from(W.entries())){let n=(0,D.rs)(i.asset),r=parseInt(i.slug.split("-").pop()||"0",10),a=Math.max(0,r+900-Math.floor(Date.now()/1e3)),o=n&&n.conditionId!==i.marketId,l=a<=0;if(!o&&!l)continue;let d=_.get(t)||0;if(Date.now()-d<5e3)continue;_.set(t,Date.now());let c=U.get(i.marketId);if(!c){s.k.warn(`[Resolution] No cached MarketInfo for ${t}, cannot resolve`);continue}let g=await u(i.slug);if(null===g&&(g=await p(c)),null===g){s.k.debug(`[Resolution] ${t} not resolved yet, will retry`);continue}let $={conditionId:i.marketId,side:i.side,shares:i.shares,avgEntryPrice:i.avgEntryPrice,costBasis:i.costBasis,currentPrice:i.currentPrice,unrealizedPnl:i.unrealizedPnl},m=function(e,t,i,n,r={}){let a=t.side===i,o=a?t.shares:0,l=o-t.costBasis;return s.k.info(`[${n?"PAPER":"LIVE"}] RESOLUTION: ${a?"WON":"LOST"} | ${t.shares.toFixed(4)} shares | Payout: $${o.toFixed(4)} | P&L: $${l.toFixed(4)}`),(0,f.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t.side,action:"resolution",price:"yes"===i?1:0,amount:o,shares:t.shares,pnl:l,paper:n,orderId:null,asset:r.asset||null,subStrategy:r.subStrategy||null,binancePriceAtEntry:null,slippage:null,takerFee:null})}(c,$,g,e.paperTrading,{asset:i.asset}),h=i.side===g;(0,D.E3)(i.slug,"yes"===g?"up":"down"),W.delete(t),_.delete(t),"BTC"===i.asset&&(N=null),ec(m),eu(`${i.asset} resolved ${"yes"===g?"UP":"DOWN"} - ${h?"WON":"LOST"} | P&L: $${m.pnl?.toFixed(4)}`),ep(h?"success":"warning",`${i.asset} resolved ${"yes"===g?"UP":"DOWN"}: ${h?"WON":"LOST"} ($${m.pnl?.toFixed(4)})`,i.asset)}for(let[,e]of W){let t=(0,D.rs)(e.asset);t&&(e.currentPrice="yes"===e.side?t.yesPrice:t.noPrice,e.unrealizedPnl=e.shares*e.currentPrice-e.costBasis)}}catch(e){s.k.error(`Trading loop error: ${e}`),eu(`Error: ${e}`)}ed()}}function eh(){var e,t,i;if("running"===T)return{success:!1,error:"Bot is already running"};s.k.info("Starting bot..."),T="running",A="Bot started",L=new Date().toISOString(),e=e=>ec(e),t=e=>eu(e),i=(e,t,i)=>ep(e,t,i),I=e,b=t,x=i;let n=K();return ea(),ep("info",`Market scanner active for: ${n.enabledAssets.join(", ")}`),n.paperTrading?(et=!1,ep("info","Paper mode - CLOB client not needed")):(0,a.tS)().then(e=>{(et=!!e)?ep("success","CLOB client connected - live trading ready"):ep("error","CLOB client failed - check PRIVATE_KEY and FUNDER_ADDRESS in .env.local"),ed()}).catch(()=>{et=!1,ep("error","CLOB client initialization failed"),ed()}),e$(),Z=setInterval(em,3e3),j=setInterval(e$,3e4),ed(),eu("Bot started"),ep("success","Bot started successfully"),{success:!0}}function ey(){return"stopped"===T?{success:!1,error:"Bot is already stopped"}:(s.k.info("Stopping bot..."),Z&&(clearInterval(Z),Z=null),j&&(clearInterval(j),j=null),T="stopped",et=!1,ee(),A="Bot stopped",L=new Date().toISOString(),ed(),eu("Bot stopped"),ep("info","Bot stopped"),{success:!0})}function eS(){return Y=!1,J=null,V=null,ep("info","Circuit breaker manually reset"),ed(),{success:!0}}}};