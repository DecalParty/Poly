"use strict";exports.id=129,exports.ids=[129],exports.modules={81129:(e,t,i)=>{i.d(t,{y0:()=>em,ap:()=>ei,xS:()=>eP,zX:()=>eS,hC:()=>ek,BU:()=>ed});var n=i(24263),r=i(72019),a=i(21925),s=i(43895);let o=process.env.GAMMA_API_URL||"https://gamma-api.polymarket.com",l={"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Language":"en-US,en;q=0.9","Accept-Encoding":"gzip, deflate, br"};async function d(e,t=3){for(let i=0;i<t;i++)try{return(await (0,n.Z)({...e,headers:{...l,...e.headers}})).data}catch(o){if(i===t-1)throw o;let r=n.Z.isAxiosError(o)?o.response?.status:void 0;if(r&&r>=400&&r<500&&429!==r)throw o;let a=Math.min(1e3*Math.pow(2,i),8e3);s.k.warn(`[Markets] Request to ${e.url} failed (attempt ${i+1}/${t}), retrying in ${a}ms...`),await new Promise(e=>setTimeout(e,a))}throw Error("Unreachable")}async function c(e){try{let t=await d({method:"get",url:`${o}/markets`,params:{slug:e},timeout:1e4});if(!t||!Array.isArray(t)||0===t.length)return s.k.debug(`No market found for slug: ${e}`),null;let i=t[0],n=i.clobTokenIds?"string"==typeof i.clobTokenIds?JSON.parse(i.clobTokenIds):i.clobTokenIds:[];if(n.length<2)return s.k.warn(`Market ${e} has insufficient token IDs`),null;return{conditionId:i.conditionId,slug:i.slug||e,question:i.question||"BTC 15m candle",yesTokenId:n[0],noTokenId:n[1],endDate:i.endDate||i.endDateIso||"",endTimestamp:i.endDate?new Date(i.endDate).getTime()/1e3:0,active:!1!==i.active&&!i.closed,tickSize:i.orderPriceMinTickSize||"0.01",negRisk:!0===i.negRisk}}catch(i){if(n.Z.isAxiosError(i)&&i.response?.status===404)return null;let t=n.Z.isAxiosError(i)?`${i.response?.status||"network"} - ${i.response?.statusText||i.message}`:String(i);return s.k.error(`Error fetching market ${e}: ${t}`),null}}async function u(){let e=function(){let e=Math.floor(Date.now()/1e3);return`btc-updown-15m-${900*Math.floor(e/900)}`}(),t=await c(e);if(t&&t.active)return t;let i=Math.floor(Date.now()/1e3),n=`btc-updown-15m-${(Math.floor(i/900)-1)*900}`;return(t=await c(n))&&t.active?t:null}async function p(e){try{let t=(0,a.YX)(),[i,n]=await Promise.all([t.getOrderBook(e.yesTokenId).catch(()=>null),t.getOrderBook(e.noTokenId).catch(()=>null)]),r=.5,s=.5;i&&(i.asks&&i.asks.length>0?r=parseFloat(i.asks[0].price):i.last_trade_price&&(r=parseFloat(i.last_trade_price))),n&&(n.asks&&n.asks.length>0?s=parseFloat(n.asks[0].price):n.last_trade_price&&(s=parseFloat(n.last_trade_price))),r>0&&.5===s?s=Math.max(.01,1-r):s>0&&.5===r&&(r=Math.max(.01,1-s));let o=r>=s?"yes":"no",l="yes"===o?r:s;return{yesPrice:r,noPrice:s,leadingSide:o,leadingPrice:l,timestamp:Date.now()}}catch(e){return s.k.error(`Error fetching prices: ${e}`),null}}async function g(e){try{let t=await d({method:"get",url:`${o}/markets`,params:{slug:e},timeout:1e4});if(!t||!Array.isArray(t)||0===t.length)return s.k.debug(`[Resolution] No market found for slug: ${e}`),null;let i=t[0];if(!0===i.active&&!i.closed)return s.k.debug(`[Resolution] ${e} still active (active=${i.active}, closed=${i.closed})`),null;if(i.outcomePrices){let t;if("string"==typeof i.outcomePrices)try{let e=JSON.parse(i.outcomePrices);t=Array.isArray(e)?e.map(Number):i.outcomePrices.split(",").map(Number)}catch{t=i.outcomePrices.split(",").map(Number)}else{if(!Array.isArray(i.outcomePrices))return s.k.debug(`[Resolution] ${e} unexpected outcomePrices type: ${typeof i.outcomePrices}`),null;t=i.outcomePrices.map(Number)}if(t.length>=2&&!t.some(isNaN)){if(t[0]>t[1])return s.k.info(`[Resolution] ${e} resolved YES/UP (prices: ${t})`),"yes";if(t[1]>t[0])return s.k.info(`[Resolution] ${e} resolved NO/DOWN (prices: ${t})`),"no"}s.k.debug(`[Resolution] ${e} outcomePrices inconclusive: ${JSON.stringify(t)}`)}else s.k.debug(`[Resolution] ${e} closed but no outcomePrices (active=${i.active}, closed=${i.closed})`);return null}catch(t){return s.k.error(`[Resolution] Failed to fetch ${e}: ${t}`),null}}async function f(e){try{let t=(0,a.YX)(),i=await t.getMidpoints([{token_id:e.yesTokenId,side:r.MF.BUY},{token_id:e.noTokenId,side:r.MF.BUY}]),n=parseFloat(i?.[e.yesTokenId]||"0"),o=parseFloat(i?.[e.noTokenId]||"0");if(s.k.debug(`[Resolution CLOB] ${e.slug} YES=${n} NO=${o}`),n>.9)return"yes";if(o>.9)return"no";return null}catch(t){return s.k.debug(`[Resolution CLOB] Failed for ${e.slug}: ${t}`),null}}async function $(e){try{let t=(0,a.YX)(),i=await t.getMidpoints([{token_id:e.yesTokenId,side:r.MF.BUY},{token_id:e.noTokenId,side:r.MF.BUY}]),n=parseFloat(i?.[e.yesTokenId]||"0.5"),s=parseFloat(i?.[e.noTokenId]||"0.5"),o=n>=s?"yes":"no";return{yesPrice:n,noPrice:s,leadingSide:o,leadingPrice:"yes"===o?n:s,timestamp:Date.now()}}catch{return p(e)}}var m=i(3412);function h(e,t){let i=t*(1-t);return .25*e*i*i}async function y(e,t,i,n,r,o,l={}){let d=n/i,c="yes"===t?e.yesTokenId:e.noTokenId,u=h(d,i),p=l.expectedPrice?Math.abs(i-l.expectedPrice)/l.expectedPrice:0;if(r)return s.k.info(`[PAPER] BUY ${d.toFixed(4)} ${t} @ $${i.toFixed(4)} ($${n}) | Asset: ${l.asset||"?"} | Strategy: ${l.subStrategy||"?"} | Fee: $${u.toFixed(6)}`),{trade:(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t,action:"buy",price:i,amount:n,shares:d,pnl:null,paper:!0,orderId:null,asset:l.asset||null,subStrategy:l.subStrategy||null,binancePriceAtEntry:null,slippage:p,takerFee:u})};s.k.info(`[LIVE] Placing BUY: ${d.toFixed(4)} ${t} @ $${i.toFixed(4)}`);let g=await (0,a.L4)(c,i,d,e.tickSize,e.negRisk);return g.success?{trade:(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t,action:"buy",price:i,amount:n,shares:d,pnl:null,paper:!1,orderId:g.orderId||null,asset:l.asset||null,subStrategy:l.subStrategy||null,binancePriceAtEntry:null,slippage:p,takerFee:u})}:(s.k.error(`Buy order failed: ${g.error}`),{trade:null,error:g.error})}async function S(e,t,i,n,r={}){let o="yes"===t.side?e.yesTokenId:e.noTokenId,l=t.shares*i,d=l-t.costBasis,c=h(t.shares,i);if(n)return s.k.info(`[PAPER] SELL ${t.shares.toFixed(4)} ${t.side} @ $${i.toFixed(4)} | P&L: $${d.toFixed(4)}`),{trade:(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t.side,action:"sell",price:i,amount:l,shares:t.shares,pnl:d,paper:!0,orderId:null,asset:r.asset||null,subStrategy:r.subStrategy||null,binancePriceAtEntry:null,slippage:null,takerFee:c})};s.k.info(`[LIVE] Placing SELL: ${t.shares.toFixed(4)} ${t.side} @ $${i.toFixed(4)}`);let u=await (0,a.EG)(o,i,t.shares,e.tickSize,e.negRisk);return u.success?{trade:(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t.side,action:"sell",price:i,amount:l,shares:t.shares,pnl:d,paper:!1,orderId:u.orderId||null,asset:r.asset||null,subStrategy:r.subStrategy||null,binancePriceAtEntry:null,slippage:null,takerFee:c})}:(s.k.error(`Sell order failed: ${u.error}`),{trade:null,error:u.error})}let k=null,P={windowsPlayed:0,bothSidesFilled:0,oneSideFilled:0,neitherFilled:0,totalPnl:0,avgProfitPerWindow:0},w=null,I=0,b=30,x=()=>{},M=()=>{},v=()=>{};async function F(e,t,i){if(!e.arbEnabled)return;let n=t.find(t=>t.asset===e.arbMarket);if(!n)return;let r=Math.floor(Date.now()/1e3),a=900*Math.floor(r/900),s=`${e.arbMarket.toLowerCase()}-arb-${a}`,o=a+900-r;if(k&&k.windowId!==s&&(await D(k,i),k=null,w=null),k&&o<=e.arbCancelBeforeEnd&&"active"===k.status&&(await T(k,i),k.status="cancelling",M(`[ARB] Cancelled unfilled orders -- ${o}s before resolution`)),!(o<=e.arbCancelBeforeEnd)){if(w===s){i&&k&&"active"===k.status&&function(e,t){let i=t.yesPrice,n=t.noPrice,r=!1;for(let t of e.upSide.orders)if(("placed"===t.status||"partial"===t.status)&&i<=t.price+.02){let e=i<=t.price?1:.3,n=t.targetSize*e;n>t.filledSize&&(t.filledSize=n,t.status=t.filledSize>=t.targetSize?"filled":"partial",r=!0)}for(let t of e.downSide.orders)if(("placed"===t.status||"partial"===t.status)&&n<=t.price+.02){let e=n<=t.price?1:.3,i=t.targetSize*e;i>t.filledSize&&(t.filledSize=i,t.status=t.filledSize>=t.targetSize?"filled":"partial",r=!0)}r&&(E(e.upSide),E(e.downSide),C())}(k,n);return}if(b<e.arbMaxPerWindow)return;await B(e,n,s,a,i)}}async function B(e,t,i,n,r){let o=null!=e.arbBudgetUp&&e.arbBudgetUp>0?e.arbBudgetUp:e.arbMaxPerWindow/2,l=null!=e.arbBudgetDown&&e.arbBudgetDown>0?e.arbBudgetDown:e.arbMaxPerWindow/2,d=[],c=[];for(let u of e.arbLadderLevels){let e=o*u.allocation,p=l*u.allocation,g=e/u.price,f=p/u.price,$={side:"yes",price:u.price,targetSize:g,filledSize:0,orderId:null,status:"pending"},m={side:"no",price:u.price,targetSize:f,filledSize:0,orderId:null,status:"pending"};if(r)$.orderId=`paper-up-${u.price}-${n}`,$.status="placed",m.orderId=`paper-down-${u.price}-${n}`,m.status="placed";else{let e=await (0,a.pQ)(t.yesTokenId,u.price,g,t.tickSize,t.negRisk);e.success&&e.orderId&&($.orderId=e.orderId,$.status="placed");let i=await (0,a.pQ)(t.noTokenId,u.price,f,t.tickSize,t.negRisk);i.success&&i.orderId&&(m.orderId=i.orderId,m.status="placed")}d.push($),c.push(m),s.k.info(`[ARB] Limit order: UP $${u.price} x ${g.toFixed(2)} shares | DOWN $${u.price} x ${f.toFixed(2)} shares | window=${i}`)}b-=e.arbMaxPerWindow,I=e.arbMaxPerWindow,k={windowId:i,conditionId:t.conditionId,slug:t.slug,asset:e.arbMarket,startTime:n,endTime:n+900,secondsRemaining:n+900-Math.floor(Date.now()/1e3),upSide:{totalShares:0,totalCost:0,avgPrice:0,orders:d},downSide:{totalShares:0,totalCost:0,avgPrice:0,orders:c},combinedCost:0,guaranteedPnl:0,status:"active",resolution:"pending",pnl:null},w=i,P.windowsPlayed++,M(`[ARB] Placed ${2*e.arbLadderLevels.length} limit orders for ${i}`),v("info",`Arb: Placed ladder orders for ${e.arbMarket}`,e.arbMarket)}function E(e){let t=0,i=0;for(let n of e.orders)t+=n.filledSize,i+=n.filledSize*n.price;e.totalShares=t,e.totalCost=i,e.avgPrice=t>0?i/t:0}function C(){if(!k)return;let e=k.upSide,t=k.downSide;if(e.avgPrice>0&&t.avgPrice>0){k.combinedCost=e.avgPrice+t.avgPrice;let i=Math.min(e.totalShares,t.totalShares);k.guaranteedPnl=i*(1-k.combinedCost)}else e.avgPrice>0||t.avgPrice>0?k.combinedCost=e.avgPrice+t.avgPrice:k.combinedCost=0,k.guaranteedPnl=0}async function T(e,t){let i=[];for(let n of[...e.upSide.orders,...e.downSide.orders])("placed"===n.status||"partial"===n.status)&&n.orderId&&(t||i.push(n.orderId),n.status="cancelled");i.length>0&&!t&&await (0,a._e)(i),E(e.upSide),E(e.downSide),C(),s.k.info(`[ARB] Cancelled ${i.length} unfilled orders | UP: ${e.upSide.totalShares.toFixed(2)} shares | DOWN: ${e.downSide.totalShares.toFixed(2)} shares | Combined: $${e.combinedCost.toFixed(3)}`)}async function D(e,t){"active"===e.status&&await T(e,t),e.status="resolved";let i=e.upSide.totalShares,n=e.downSide.totalShares,r=e.upSide.totalCost,a=e.downSide.totalCost,o=r+a,l=i>0&&n>0,d=i>0!=n>0;if(l?P.bothSidesFilled++:d?P.oneSideFilled++:P.neitherFilled++,0===o){b=Math.min(30,b+I),M(`[ARB] Window ${e.windowId} -- no fills, capital returned`);return}if(i>0){let n=(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"yes",action:"buy",price:e.upSide.avgPrice,amount:r,shares:i,pnl:null,paper:t,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:0});x(n)}if(n>0){let i=(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"no",action:"buy",price:e.downSide.avgPrice,amount:a,shares:n,pnl:null,paper:t,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:0});x(i)}if(t&&o>0){let t=Math.random()>.5,s=t?1*i:0,l=t?0:1*n,d=s+l,c=d-o;if(e.resolution=t?"up":"down",e.pnl=c,i>0){let n=(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"yes",action:"resolution",price:t?1:0,amount:s,shares:i,pnl:s-r,paper:!0,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:null});x(n)}if(n>0){let i=(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:"no",action:"resolution",price:t?0:1,amount:l,shares:n,pnl:l-a,paper:!0,orderId:null,asset:e.asset,subStrategy:"arbitrage",binancePriceAtEntry:null,slippage:null,takerFee:null});x(i)}P.totalPnl+=c,P.bothSidesFilled+P.oneSideFilled>0&&(P.avgProfitPerWindow=P.totalPnl/(P.bothSidesFilled+P.oneSideFilled)),b=Math.min(30,b+d),M(`[ARB] ${c>=0?"WIN":"LOSS"} Window resolved ${t?"UP":"DOWN"} | Invested: $${o.toFixed(2)} | Payout: $${d.toFixed(2)} | P&L: $${c.toFixed(2)}`),v(c>=0?"success":"warning",`Arb ${t?"UP":"DOWN"}: P&L $${c.toFixed(2)} (invested $${o.toFixed(2)})`,e.asset)}else b=Math.min(30,b+o);s.k.info(`[ARB] Window summary: ${e.windowId} | UP: ${i.toFixed(2)} @ $${e.upSide.avgPrice.toFixed(3)} | DOWN: ${n.toFixed(2)} @ $${e.downSide.avgPrice.toFixed(3)} | Combined: $${e.combinedCost.toFixed(3)} | P&L: ${null!==e.pnl?"$"+e.pnl.toFixed(2):"pending"}`)}var A=i(24979);let O="stopped",L="disconnected",z="Idle",R=null,N=null,W=null,U=null,_=new Map,Y=new Map,j=new Map,q=!1,G=null,J=null,V=[],X=0,Z=null,H=null,K=null,Q=null,ee=0;function et(){let e=Date.now();return(!Q||e-ee>5e3)&&(Q=(0,m.Gw)(),ee=e),Q}function ei(){Q=null,ee=0}let en=!1,er={},ea=new Set,es=!1;function eo(){if(es)return;es=!0;let e=et();(0,A.up)(e.enabledAssets),s.k.info("[Engine] Auto-started market scanner for dashboard")}let el="";function ed(e){return eo(),function(){if(K)return;let e=0;K=setInterval(()=>{if(0===ea.size)return;let t=et(),i={};for(let e of(0,A.$2)())i[e.asset]=e;0===Object.keys(i).length?(5==++e||e%30==0)&&(s.k.warn(`[Engine] No active markets found after ${e} broadcast cycles - Polymarket API may be unreachable from this server`),eg("No market data - Polymarket API may be unreachable from this server. Check logs for details.")):e=0;let n=(0,A.bp)(t.enabledAssets),r=JSON.stringify(n),a=r!==el;a&&(el=r),ec({type:"price",data:{markets:i,...a?{recentOutcomes:n}:{}},timestamp:new Date().toISOString()})},2e3)}(),ea.add(e),e({type:"state",data:em(),timestamp:new Date().toISOString()}),()=>ea.delete(e)}function ec(e){for(let t of ea)try{t(e)}catch{ea.delete(t)}}function eu(){ec({type:"state",data:em(),timestamp:new Date().toISOString()})}function ep(e){ec({type:"trade",data:e,timestamp:new Date().toISOString()})}function eg(e){ec({type:"log",data:{message:e},timestamp:new Date().toISOString()})}function ef(e,t,i){let n={id:`alert-${++X}`,timestamp:new Date().toISOString(),severity:e,message:t,asset:i};V.unshift(n),V.length>100&&(V.length=100),ec({type:"alert",data:n,timestamp:n.timestamp})}function e$(e){let t=0;for(let e of _.values())t+=e.costBasis;t+=k?k.upSide.totalCost+k.downSide.totalCost:0;let i=(0,m._l)(),n=(0,m.uF)(),r=(0,m.vs)();return{totalBankroll:e.totalBankroll,deployed:t,available:Math.max(0,e.maxTotalExposure-t),maxExposure:e.maxTotalExposure,todayPnl:i,winStreak:r,totalLosses:n}}function em(){let e;let t=et(),i=function(){let e=Math.floor(Date.now()/1e3);return(Math.floor(e/900)+1)*900-e}(),n=!1;N?W?i>t.highConfTimeMax?e=`${(i/60).toFixed(1)}m remaining (need <= ${Math.floor(t.highConfTimeMax/60)}m)`:W.leadingPrice<t.highConfEntryMin||W.leadingPrice>t.highConfEntryMax?e=`Price $${W.leadingPrice.toFixed(4)} outside range $${t.highConfEntryMin}-$${t.highConfEntryMax}`:n=!0:e="Waiting for price data":e="No active market found";let r={market:N,prices:W,secondsRemaining:i,eligible:n,ineligibleReason:e},a={};for(let e of(0,A.$2)())a[e.asset]=e;let s={};for(let[e,t]of _)s[e]=t;return{status:O,connection:L,lastAction:z,lastActionTime:R,currentMarket:r,currentPosition:U,settings:t,cumulativePnl:(0,m.NW)(),totalTrades:(0,m.yW)(),activeMarkets:a,positions:s,capital:e$(t),circuitBreaker:{triggered:q,reason:G,resumeAt:J,dailyPnl:(0,m._l)(),totalLosses:(0,m.uF)()},clobReady:en,alerts:V.slice(0,50),arbState:function(){if(!k)return null;let e=Math.floor(Date.now()/1e3);return k.secondsRemaining=Math.max(0,k.endTime-e),C(),{...k}}(),arbStats:{...P}}}async function eh(){try{L="connecting";let e=await u();if(e){N&&N.conditionId!==e.conditionId&&s.k.info(`Market rotated: ${N.slug} -> ${e.slug}`),N=e,Y.set(e.conditionId,e),L="connected";let t=await $(e);t&&(W=t,U&&(U.currentPrice="yes"===U.side?t.yesPrice:t.noPrice,U.unrealizedPnl=U.shares*U.currentPrice-U.costBasis))}else N=null,W=null,L="connected"}catch(t){L="disconnected";let e=[t?.message?`message=${t.message}`:null,t?.code?`code=${t.code}`:null,t?.name?`name=${t.name}`:null,t?.response?.status?`status=${t.response.status}`:null,t?.config?.url?`url=${t.config.url}`:null].filter(Boolean).join(" ");s.k.error(`Market refresh failed${e?` (${e})`:""}`),eg(`Connection error${e?`: ${e}`:""}`)}eu()}async function ey(){if("running"===O){try{let e=et();if(function(e){if(q){if(J){let e=new Date(J).getTime();if(Date.now()>=e)return q=!1,G=null,J=null,ef("info","Circuit breaker cooldown ended. Bot resumed."),!1}return!0}let t=(0,m._l)();if(t<-e.dailyLossLimit)return q=!0,G=`Daily loss $${Math.abs(t).toFixed(2)} exceeded limit $${e.dailyLossLimit}`,J=new Date(Date.now()+144e5).toISOString(),ef("error",`Circuit breaker triggered: ${G}. Pausing for 4 hours.`),!0;let i=(0,m.uF)();return i>=e.lossLimit&&(q=!0,G=`${i} losses today (limit: ${e.lossLimit})`,ef("error",`Circuit breaker triggered: ${G}. Bot stopped.`),!0)}(e)){eu();return}let t=(0,A.$2)();if(0===t.length){let e=Date.now(),t=er._noMarkets;(!t||e-t.time>=15e3)&&(er._noMarkets={reason:"no markets",time:e},eg("Scanning for active 15-minute markets..."))}for(let i of t){if(!e.enabledAssets.includes(i.asset))continue;let t=`${i.asset}-${i.conditionId}`,n=_.get(t)||null;if(!n&&_.size>=e.maxSimultaneousPositions)continue;let r=function(e,t,i,n){let r=t.secondsRemaining,a=t.yesPrice,s=t.noPrice;if(!e.highConfEnabled)return{action:"wait",reason:"High-confidence strategy disabled"};let o=a>=s?"yes":"no",l="yes"===o?a:s;if(n&&n.shares>0){if(r>=e.highConfTimeMin&&r<=e.highConfTimeMax&&l>=e.highConfEntryMin&&l<=e.highConfEntryMax&&o===n.side){let i=Date.now(),r=1e3*e.highConfBuyInterval;if(!n.lastBuyTime||i-n.lastBuyTime>=r)return{action:"buy",reason:`DCA: ${t.asset} ${n.side.toUpperCase()} @ $${l.toFixed(4)} � every ${e.highConfBuyInterval}s � $${n.costBasis.toFixed(2)} deployed`,side:n.side,price:l}}return{action:"hold",reason:`Holding ${n.side.toUpperCase()} @ $${n.avgEntryPrice.toFixed(4)} � ${n.shares.toFixed(2)} shares � $${n.costBasis.toFixed(2)}`}}return r<e.highConfTimeMin?{action:"wait",reason:`Window closing in ${r}s � no new entries`}:r>e.highConfTimeMax?{action:"wait",reason:`${t.asset}: ${Math.floor(r/60)}m left � waiting for ?${Math.floor(e.highConfTimeMax/60)}m`}:l>=e.highConfEntryMin&&l<=e.highConfEntryMax?{action:"buy",reason:`Entry: ${t.asset} ${o.toUpperCase()} @ $${l.toFixed(4)} (${Math.floor(r/60)}m left)`,side:o,price:l}:{action:"wait",reason:`${t.asset}: $${l.toFixed(4)} outside range $${e.highConfEntryMin}�$${e.highConfEntryMax}`}}(e,i,0,n);switch(r.action){case"buy":{if(!r.side||!r.price)break;let a=n?n.side:r.side,s="yes"===a?i.yesPrice:i.noPrice,o=e.highConfBuyAmount,l=Math.max(0,e.maxTotalExposure-e$(e).deployed);if((o=Math.min(o,e.perWindowMax-(n?.costBasis??0),l))<=0||n&&n.costBasis>=e.perWindowMax)break;let{trade:d,error:c}=await y(i.market,a,s,o,e.paperTrading,n?{conditionId:n.marketId,side:n.side,shares:n.shares,avgEntryPrice:n.avgEntryPrice,costBasis:n.costBasis,currentPrice:n.currentPrice,unrealizedPnl:n.unrealizedPnl}:null,{asset:i.asset,subStrategy:"highConfidence",expectedPrice:s});d?(n?(n.shares+=d.shares,n.costBasis+=d.amount,n.avgEntryPrice=n.costBasis/n.shares,n.lastBuyTime=Date.now()):(_.set(t,{marketId:i.conditionId,slug:i.slug,asset:i.asset,side:a,shares:d.shares,avgEntryPrice:s,currentPrice:s,unrealizedPnl:0,entryTime:new Date().toISOString(),hedged:!1,costBasis:d.amount,subStrategy:"highConfidence",lastBuyTime:Date.now()}),Y.set(i.conditionId,i.market),"BTC"===i.asset&&(U={conditionId:i.conditionId,side:a,shares:d.shares,avgEntryPrice:s,costBasis:d.amount,currentPrice:s,unrealizedPnl:0})),z=`Buy ${i.asset} ${a} @ $${s.toFixed(4)}`,R=new Date().toISOString(),ep(d),ef("info",`Buy: ${i.asset} ${a.toUpperCase()} @ $${s.toFixed(4)}`,i.asset)):c&&eg(`Buy failed (${i.asset}): ${c}`),eg(r.reason);break}case"sell":{if(!n||!r.price||!r.side)break;let{trade:a,error:s}=await S(i.market,{conditionId:n.marketId,side:n.side,shares:n.shares,avgEntryPrice:n.avgEntryPrice,costBasis:n.costBasis,currentPrice:n.currentPrice,unrealizedPnl:n.unrealizedPnl},r.price,e.paperTrading,{asset:i.asset});a?(z=`Sold ${i.asset} ${n.side} @ $${r.price.toFixed(4)}`,R=new Date().toISOString(),_.delete(t),"BTC"===i.asset&&(U=null),ep(a),ef("warning",`Sold: ${i.asset} @ $${r.price.toFixed(4)} | P&L: $${a.pnl?.toFixed(4)}`,i.asset)):s&&eg(`Sell failed (${i.asset}): ${s}`),eg(r.reason);break}case"hold":case"wait":{let e=Date.now(),t=er[i.asset],n=!t||t.reason!==r.reason,a=!t||e-t.time>=15e3;(n||a)&&(er[i.asset]={reason:r.reason,time:e},eg(r.reason))}}}try{await F(e,t,e.paperTrading)}catch(e){s.k.error(`[ARB] Tick error: ${e}`)}for(let[t,i]of Array.from(_.entries())){let n=(0,A.rs)(i.asset),r=parseInt(i.slug.split("-").pop()||"0",10),a=Math.max(0,r+900-Math.floor(Date.now()/1e3)),o=n&&n.conditionId!==i.marketId,l=a<=0;if(!o&&!l)continue;let d=j.get(t)||0;if(Date.now()-d<5e3)continue;j.set(t,Date.now());let c=Y.get(i.marketId);if(!c){s.k.warn(`[Resolution] No cached MarketInfo for ${t}, cannot resolve`);continue}let u=await g(i.slug);if(null===u&&(u=await f(c)),null===u){s.k.debug(`[Resolution] ${t} not resolved yet, will retry`);continue}let p={conditionId:i.marketId,side:i.side,shares:i.shares,avgEntryPrice:i.avgEntryPrice,costBasis:i.costBasis,currentPrice:i.currentPrice,unrealizedPnl:i.unrealizedPnl},$=function(e,t,i,n,r={}){let a=t.side===i,o=a?t.shares:0,l=o-t.costBasis;return s.k.info(`[${n?"PAPER":"LIVE"}] RESOLUTION: ${a?"WON":"LOST"} | ${t.shares.toFixed(4)} shares | Payout: $${o.toFixed(4)} | P&L: $${l.toFixed(4)}`),(0,m.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:t.side,action:"resolution",price:"yes"===i?1:0,amount:o,shares:t.shares,pnl:l,paper:n,orderId:null,asset:r.asset||null,subStrategy:r.subStrategy||null,binancePriceAtEntry:null,slippage:null,takerFee:null})}(c,p,u,e.paperTrading,{asset:i.asset}),h=i.side===u;(0,A.E3)(i.slug,"yes"===u?"up":"down"),_.delete(t),j.delete(t),"BTC"===i.asset&&(U=null),ep($),eg(`${i.asset} resolved ${"yes"===u?"UP":"DOWN"} - ${h?"WON":"LOST"} | P&L: $${$.pnl?.toFixed(4)}`),ef(h?"success":"warning",`${i.asset} resolved ${"yes"===u?"UP":"DOWN"}: ${h?"WON":"LOST"} ($${$.pnl?.toFixed(4)})`,i.asset)}for(let[,e]of _){let t=(0,A.rs)(e.asset);t&&(e.currentPrice="yes"===e.side?t.yesPrice:t.noPrice,e.unrealizedPnl=e.shares*e.currentPrice-e.costBasis)}}catch(e){s.k.error(`Trading loop error: ${e}`),eg(`Error: ${e}`)}eu()}}function eS(){var e,t,i;if("running"===O)return{success:!1,error:"Bot is already running"};s.k.info("Starting bot..."),O="running",z="Bot started",R=new Date().toISOString(),e=e=>ep(e),t=e=>eg(e),i=(e,t,i)=>ef(e,t,i),x=e,M=t,v=i;let n=et();return eo(),ef("info",`Market scanner active for: ${n.enabledAssets.join(", ")}`),n.paperTrading?(en=!1,ef("info","Paper mode - CLOB client not needed")):(0,a.tS)().then(e=>{(en=!!e)?ef("success","CLOB client connected - live trading ready"):ef("error","CLOB client failed - check PRIVATE_KEY and FUNDER_ADDRESS in .env.local"),eu()}).catch(()=>{en=!1,ef("error","CLOB client initialization failed"),eu()}),eh(),Z=setInterval(ey,3e3),H=setInterval(eh,3e4),eu(),eg("Bot started"),ef("success","Bot started successfully"),{success:!0}}function ek(){return"stopped"===O?{success:!1,error:"Bot is already stopped"}:(s.k.info("Stopping bot..."),Z&&(clearInterval(Z),Z=null),H&&(clearInterval(H),H=null),O="stopped",en=!1,ei(),z="Bot stopped",R=new Date().toISOString(),eu(),eg("Bot stopped"),ef("info","Bot stopped"),{success:!0})}function eP(){return q=!1,G=null,J=null,ef("info","Circuit breaker manually reset"),eu(),{success:!0}}}};