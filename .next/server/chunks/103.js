"use strict";exports.id=103,exports.ids=[103],exports.modules={57103:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{BU:()=>w,ap:()=>S,hC:()=>D,xS:()=>M,y0:()=>b,zX:()=>F});var r=i(97320),a=i(9854),s=i(95490),o=i(3412),l=i(24979),c=i(21925),d=i(91162),u=i(47152),p=i(90399),f=i(12792),g=i(43895),$=e([r,a,s,l,c,d]);[r,a,s,l,c,d]=$.then?(await $)():$;let O="stopped",L="disconnected",v="Idle",R=null,B=null,_=null,U=new Map,H=new Map,N=[],V=[],z=[],W=[],G=0,Y=0,J=0,X=0,j=!1,q=null,Z=null,K=[],Q=0,ee=null,et=null,ei=null,en=null,er=0;function m(){let e=Date.now();return(!en||e-er>2e3)&&(en=(0,o.Gw)(),er=e),en}function S(){en=null,er=0}let ea=!1,es=null,eo=null,el=0,ec={},ed=new Set,eu=!1;function h(){if(eu)return;eu=!0;let e=m();(0,l.up)(e.enabledAssets),g.k.info("[Engine] Auto-started market scanner for dashboard")}let ep="";function I(e){let t="yes"===e.side?l.rs(e.asset)?.yesPrice??e.entryPrice:l.rs(e.asset)?.noPrice??e.entryPrice;return{id:e.id,conditionId:e.conditionId,slug:e.slug,asset:e.asset,side:e.side,entryPrice:e.entryPrice,shares:e.shares,costBasis:e.costBasis,currentPrice:t,sellPrice:e.sellPrice,sellOrderId:e.sellOrderId,buyOrderId:e.buyOrderId,entryTime:e.entryTime,windowEndTs:e.windowEndTs,unrealizedPnl:e.shares*t-e.costBasis}}function y(e){return{orderId:e.orderId,conditionId:e.conditionId,slug:e.slug,asset:e.asset,side:e.side,price:e.price,size:e.size,placedAt:e.placedAt}}function w(e){return h(),function(){if(ei)return;let e=0;ei=setInterval(()=>{if(0===ed.size)return;let t=m(),i={};for(let e of(0,l.$2)())i[e.asset]=e;0===Object.keys(i).length?(e++,(5===e||e%30==0)&&g.k.warn(`[Engine] No active markets found after ${e} broadcast cycles`)):e=0;let n=(0,l.bp)(t.enabledAssets),r=JSON.stringify(n),s=r!==ep;s&&(ep=r);let o=(0,d.zk)(),c=Object.values(i).find(e=>"BTC"===e.asset),u=c?.yesPrice??.5,p=c?.noPrice??.5,f=(0,d.ZV)(3e4),$=(0,d.VI)(18e5),S=c?.secondsRemaining??450,h=(0,a.vT)(u,p,f,(0,d.iS)(),$.direction,$.strength,S);k({type:"price",data:{markets:i,...s?{recentOutcomes:n}:{},scalp:{binancePrice:(0,d.iS)(),windowOpenPrice:(0,d.as)(),btcChangePercent:o,fairValue:h,positions:[...V.map(I),...z.map(I)],pendingBuys:W.map(y),cooldownUntil:0}},timestamp:new Date().toISOString()})},1e3)}(),(0,d.md)(),ed.add(e),e({type:"state",data:b(),timestamp:new Date().toISOString()}),()=>ed.delete(e)}function k(e){for(let t of ed)try{t(e)}catch{ed.delete(t)}}function P(){k({type:"state",data:b(),timestamp:new Date().toISOString()})}function E(e){k({type:"log",data:{message:e},timestamp:new Date().toISOString()})}function A(e,t,i){let n={id:`alert-${++Q}`,timestamp:new Date().toISOString(),severity:e,message:t,asset:i};K.unshift(n),K.length>100&&(K.length=100),k({type:"alert",data:n,timestamp:n.timestamp})}function T(e){let t=0;for(let e of V)t+=e.costBasis;for(let e of z)t+=e.costBasis;for(let e of W)t+=e.price*e.size;let i=(0,o._l)(),n=(0,o.uF)(),r=(0,o.vs)();return{totalBankroll:e.maxTotalExposure,deployed:t,available:Math.max(0,e.maxTotalExposure-t),maxExposure:e.maxTotalExposure,todayPnl:i,winStreak:r,totalLosses:n}}function b(){let e;let t=m(),i=(0,r.pi)();!function(){let e=Date.now();if(e-el<3e4)return;el=e;let t=process.env.PRIVATE_KEY,i=process.env.FUNDER_ADDRESS;if(t)try{let e=process.env.POLYGON_RPC_URL||"https://polygon-rpc.com",n=new p.StaticJsonRpcProvider(e,137),r=new u.Wallet(t,n);eo=i||r.address;let a=["function balanceOf(address) view returns (uint256)"],s=new f.Contract("0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174",a,n),o=new f.Contract("0x3c499c542cEF5E3811e1192ce70d8cC03d5c3359",a,n),l=[];i&&l.push(i),i&&i.toLowerCase()===r.address.toLowerCase()||l.push(r.address),Promise.all(l.flatMap(e=>[s.balanceOf(e).then(e=>Number(e)/1e6).catch(()=>0),o.balanceOf(e).then(e=>Number(e)/1e6).catch(()=>0)])).then(e=>{let t=e.reduce((e,t)=>e+t,0);es=t,ea&&(0,c.tS)().then(e=>{e&&e.getBalanceAllowance({asset_type:"COLLATERAL"}).then(e=>{let i=e?.balance||"0",n=parseFloat(i);es=t+(n>1e6?n/1e6:n)}).catch(()=>{})}).catch(()=>{})}).catch(()=>{})}catch{}}();let n=!1;B?_?n=!0:e="Waiting for price data":e="No active market found";let s={market:B,prices:_,secondsRemaining:i,eligible:n,ineligibleReason:e},g={};for(let e of(0,l.$2)())g[e.asset]=e;let $={};for(let[e,t]of U)$[e]=t;let S=(0,d.zk)(),h=(0,l.$2)(),w=h.length>0?h[0].secondsRemaining:450,k=h.find(e=>"BTC"===e.asset),P=k?.yesPrice??.5,E=k?.noPrice??.5,A=(0,d.ZV)(3e4),b=(0,d.VI)(18e5),x=(0,a.vT)(P,E,A,(0,d.iS)(),b.direction,b.strength,w);return{status:O,connection:L,lastAction:v,lastActionTime:R,currentMarket:s,currentPosition:null,settings:t,cumulativePnl:(0,o.NW)(),totalTrades:(0,o.yW)(),activeMarkets:g,positions:$,capital:T(t),circuitBreaker:{triggered:j,reason:q,resumeAt:Z,dailyPnl:(0,o._l)(),totalLosses:(0,o.uF)()},clobReady:ea,alerts:K.slice(0,50),arbState:null,arbStats:{windowsPlayed:0,bothSidesFilled:0,oneSideFilled:0,neitherFilled:0,totalPnl:0,avgProfitPerWindow:0},walletBalance:es,walletAddress:eo,scalp:{binancePrice:(0,d.iS)(),windowOpenPrice:(0,d.as)(),btcChangePercent:S,fairValue:x,positions:V.map(I),pendingBuys:W.map(y),cooldownUntil:0}}}async function x(){try{L="connecting";let e=await (0,r.ri)();if(e){B&&B.conditionId!==e.conditionId&&g.k.info(`Market rotated: ${B.slug} -> ${e.slug}`),B=e,H.set(e.conditionId,e),L="connected";let t=await (0,r.pw)(e);t&&(_=t)}else B=null,_=null,L="connected"}catch(e){L="disconnected",g.k.error(`Market refresh failed: ${e?.message||e}`)}P()}let ef=!1;async function C(){if("running"===O&&!ef){ef=!0;try{let t=m();if(function(e){if(j){if(Z){let e=new Date(Z).getTime();if(Date.now()>=e)return j=!1,q=null,Z=null,A("info","Circuit breaker cooldown ended. Bot resumed."),!1}return!0}let t=(0,o._l)();if(t<-e.dailyLossLimit)return j=!0,q=`Daily loss $${Math.abs(t).toFixed(2)} exceeded limit $${e.dailyLossLimit}`,Z=new Date(Date.now()+144e5).toISOString(),A("error",`Circuit breaker triggered: ${q}. Pausing for 4 hours.`),!0;let i=(0,o.uF)();return i>=e.lossLimit&&(j=!0,q=`${i} losses today (limit: ${e.lossLimit})`,A("error",`Circuit breaker triggered: ${q}. Bot stopped.`),!0)}(t)){P();return}if(!t.scalpEnabled){ef=!1;return}let i=(0,l.$2)(),n=Date.now(),u=(0,d.zk)(),p=(0,d.cs)();for(let i=W.length-1;i>=0;i--){let r=W[i],a=1e3*r.windowEndTs;if(n>a){try{await (0,c.sl)(r.orderId)}catch{}g.k.info(`[SCALP] Cancelled expired buy order ${r.orderId}`),W.splice(i,1);continue}let s=await (0,c.SX)(r.orderId);if(!s)continue;let u=s.status.toUpperCase();if("MATCHED"===u||"CLOSED"===u||"FILLED"===u){if(s.sizeFilled>0){var e;let a=s.price||r.price,u=s.sizeFilled,p=u*a,f=Math.min(.99,Math.round((a+t.scalpProfitTarget)*100)/100);e=(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:r.conditionId,slug:r.slug,side:r.side,action:"buy",price:a,amount:p,shares:u,pnl:null,paper:t.paperTrading,orderId:r.orderId,asset:r.asset,subStrategy:"scalp",binancePriceAtEntry:(0,d.iS)(),slippage:null,takerFee:0}),k({type:"trade",data:e,timestamp:new Date().toISOString()});let g=null;if(!t.paperTrading){let e=await (0,c.eE)(r.tokenId,f,u,r.tickSize,r.negRisk);e.success&&e.orderId&&(g=e.orderId)}let $=`scalp-${r.conditionId.slice(0,8)}-${Date.now()}`;V.push({id:$,conditionId:r.conditionId,slug:r.slug,asset:r.asset,side:r.side,tokenId:r.tokenId,entryPrice:a,shares:u,costBasis:p,sellPrice:f,sellOrderId:g,buyOrderId:r.orderId,entryTime:n,windowEndTs:r.windowEndTs}),v=`Scalp buy ${r.asset} ${r.side.toUpperCase()} @ $${a.toFixed(2)}`,R=new Date().toISOString(),E(`Scalp entry: ${r.side.toUpperCase()} ${u.toFixed(1)} shares @ $${a.toFixed(2)}, sell target $${f.toFixed(2)}`),A("info",`Scalp buy: ${r.side.toUpperCase()} @ $${a.toFixed(2)}`,r.asset),W.splice(i,1),H.set(r.conditionId,l.rs(r.asset)?.market)}}else if("CANCELLED"===u||"EXPIRED"===u||"REJECTED"===u)E(`Buy order ${u}: ${r.side.toUpperCase()} ${r.asset} @ $${r.price.toFixed(2)} (${r.orderId.slice(0,12)}...)`),A("warning",`Order ${u.toLowerCase()}: ${r.side.toUpperCase()} @ $${r.price.toFixed(2)}`,r.asset),W.splice(i,1);else{let e=n-r.placedAt;e>1e4&&e%15e3<1100&&E(`Order still open: ${r.side.toUpperCase()} @ $${r.price.toFixed(2)} (${Math.round(e/1e3)}s)`)}}for(let e=V.length-1;e>=0;e--){let i=V[e],s=(0,l.rs)(i.asset),d=s?"yes"===i.side?s.yesPrice:s.noPrice:i.entryPrice,p=i.windowEndTs,f=Math.max(0,p+900-Math.floor(n/1e3));if(i.sellOrderId&&!t.paperTrading){let t=await (0,c.SX)(i.sellOrderId);if(t){let r=t.status.toUpperCase();if(("MATCHED"===r||"CLOSED"===r||"FILLED"===r)&&t.sizeFilled>0){let r=t.price||i.sellPrice,a=i.shares*r-i.costBasis;(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:i.conditionId,slug:i.slug,side:i.side,action:"sell",price:r,amount:i.shares*r,shares:i.shares,pnl:a,paper:!1,orderId:i.sellOrderId,asset:i.asset,subStrategy:"scalp",binancePriceAtEntry:null,slippage:null,takerFee:0}),E(`Scalp exit: ${i.side.toUpperCase()} @ $${r.toFixed(2)} | P&L: $${a.toFixed(4)}`),A(a>=0?"success":"warning",`Scalp sold @ $${r.toFixed(2)} | P&L: $${a.toFixed(4)}`,i.asset),v=`Scalp sold ${i.asset} @ $${r.toFixed(2)}`,R=new Date().toISOString(),Y=n,X=0,V.splice(e,1);continue}}}else if(t.paperTrading&&d>=i.sellPrice){let t=i.shares*i.sellPrice-i.costBasis;(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:i.conditionId,slug:i.slug,side:i.side,action:"sell",price:i.sellPrice,amount:i.shares*i.sellPrice,shares:i.shares,pnl:t,paper:!0,orderId:null,asset:i.asset,subStrategy:"scalp",binancePriceAtEntry:null,slippage:null,takerFee:0}),E(`[PAPER] Scalp profit: ${i.side.toUpperCase()} @ $${i.sellPrice.toFixed(2)} | P&L: $${t.toFixed(4)}`),A("success",`Scalp sold @ $${i.sellPrice.toFixed(2)} | +$${t.toFixed(4)}`,i.asset),v=`Scalp sold ${i.asset} @ $${i.sellPrice.toFixed(2)}`,R=new Date().toISOString(),V.splice(e,1);continue}let g=(0,a.S2)(i.entryPrice,i.sellPrice,d,u,i.side,f,t.scalpProfitTarget,t.scalpExitWindow);if("trail"===g.action&&g.sellPrice&&g.sellPrice>i.sellPrice){if(i.sellOrderId&&!t.paperTrading)try{await (0,c.sl)(i.sellOrderId)}catch{}let e=g.sellPrice,n=null;if(!t.paperTrading&&s){let t=await (0,c.eE)(i.tokenId,e,i.shares,s.tickSize,s.negRisk);t.success&&t.orderId&&(n=t.orderId)}i.sellPrice=e,i.sellOrderId=n,E(`Trail sell: ${i.side.toUpperCase()} $${i.sellPrice.toFixed(2)}`)}else if("sell_profit"===g.action||"sell_loss"===g.action){if(i.sellOrderId&&!t.paperTrading)try{await (0,c.sl)(i.sellOrderId)}catch{}let r=g.sellPrice||d,a=i.shares*r-i.costBasis;!t.paperTrading&&s&&await (0,c.EG)(i.tokenId,r,i.shares,s.tickSize,s.negRisk),(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:i.conditionId,slug:i.slug,side:i.side,action:"sell",price:r,amount:i.shares*r,shares:i.shares,pnl:a,paper:t.paperTrading,orderId:null,asset:i.asset,subStrategy:"scalp",binancePriceAtEntry:null,slippage:null,takerFee:0}),E(`${"sell_profit"===g.action?"Profit exit":"Exit window"}: ${i.side.toUpperCase()} @ $${r.toFixed(2)} | P&L: $${a.toFixed(4)}`),A(a>=0?"success":"warning",`Scalp ${a>=0?"profit":"exit"} @ $${r.toFixed(2)}`,i.asset),Y=n,X=0,V.splice(e,1);continue}else"hold_resolution"===g.action&&E(g.reason);if(f<=0){let a=H.get(i.conditionId);if(a){let s=await (0,r.r_)(i.slug);if(null===s&&(s=await (0,r.P_)(a)),null!==s){let r=i.side===s,d=r?1:0,u=i.shares*d-i.costBasis;if(i.sellOrderId&&!t.paperTrading)try{await (0,c.sl)(i.sellOrderId)}catch{}(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:i.conditionId,slug:i.slug,side:i.side,action:"resolution",price:d,amount:i.shares*d,shares:i.shares,pnl:u,paper:t.paperTrading,orderId:null,asset:i.asset,subStrategy:"scalp",binancePriceAtEntry:null,slippage:null,takerFee:null}),(0,l.E3)(i.slug,"yes"===s?"up":"down"),E(`Resolution: ${i.side.toUpperCase()} ${r?"WON":"LOST"} | P&L: $${u.toFixed(4)}`),A(r?"success":"warning",`Resolved ${r?"WON":"LOST"}: $${u.toFixed(4)}`,i.asset),!t.paperTrading&&r&&N.push({conditionId:a.conditionId,negRisk:a.negRisk,asset:i.asset,attempts:0,nextAttempt:n+5e3}),V.splice(e,1)}}}}for(let e=z.length-1;e>=0;e--){let i=z[e],a=(0,l.rs)(i.asset),u="yes"===i.side?a?.yesPrice??i.entryPrice:a?.noPrice??i.entryPrice,p=a?.secondsRemaining??0,f=(0,d.as)(),g=f>0?((0,d.iS)()-f)/f*100:0,$=(0,s.Px)(i.entryPrice,u,g,i.side,p,t.valueProfitTarget,t.valueExitWindow);if("sell_profit"===$.action||"sell_loss"===$.action){if(i.sellOrderId&&!t.paperTrading)try{await (0,c.sl)(i.sellOrderId)}catch{}let r=$.sellPrice||u,s=i.shares*r-i.costBasis;!t.paperTrading&&a&&await (0,c.EG)(i.tokenId,r,i.shares,a.tickSize,a.negRisk),(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:i.conditionId,slug:i.slug,side:i.side,action:"sell",price:r,amount:i.shares*r,shares:i.shares,pnl:s,paper:t.paperTrading,orderId:null,asset:i.asset,subStrategy:"scalp",binancePriceAtEntry:null,slippage:null,takerFee:0}),E(`${$.reason} | P&L: $${s.toFixed(4)}`),A(s>=0?"success":"warning",`Value ${s>=0?"profit":"exit"} @ $${r.toFixed(2)}`,i.asset),J=n,z.splice(e,1);continue}if("hold_resolution"===$.action&&p<=0){let a=H.get(i.conditionId);if(a){let s=await (0,r.r_)(i.slug);if(null===s&&(s=await (0,r.P_)(a)),null!==s){let r=i.side===s,c=r?1:0,d=i.shares*c-i.costBasis;(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:i.conditionId,slug:i.slug,side:i.side,action:"resolution",price:c,amount:i.shares*c,shares:i.shares,pnl:d,paper:t.paperTrading,orderId:null,asset:i.asset,subStrategy:"scalp",binancePriceAtEntry:null,slippage:null,takerFee:null}),(0,l.E3)(i.slug,"yes"===s?"up":"down"),E(`[VALUE] Resolution: ${i.side.toUpperCase()} ${r?"WON":"LOST"} | P&L: $${d.toFixed(4)}`),A(r?"success":"warning",`Value ${r?"WON":"LOST"}: $${d.toFixed(4)}`,i.asset),!t.paperTrading&&r&&N.push({conditionId:a.conditionId,negRisk:a.negRisk,asset:i.asset,attempts:0,nextAttempt:n+5e3}),z.splice(e,1)}}}}if(n-G>=500){if(G=n,p)for(let e of i){if(!t.enabledAssets.includes(e.asset))continue;let i=(0,d.ZV)(3e4),r=(0,d.ZV)(5e3),l=(0,d.iS)(),u=(0,d.VI)(18e5);if(t.scalpEnabled){let s=V.filter(t=>t.conditionId===e.conditionId).length,p=W.filter(t=>t.conditionId===e.conditionId).length;if(s+p<t.scalpMaxPositions){let s=T(t),p=e.secondsRemaining<=t.scalpHalfSizeAfter?t.scalpTradeSize/2:t.scalpTradeSize;if(s.available>=p){let s=(0,a.XE)(e.yesPrice,e.noPrice,i,r,l,u.direction,u.strength,e.secondsRemaining,t.scalpMinGap,t.scalpEntryMin,t.scalpEntryMax,t.scalpExitWindow,Y,X),f=(0,a.vT)(e.yesPrice,e.noPrice,i,l,u.direction,u.strength,e.secondsRemaining);X=Math.max(f.up-e.yesPrice,f.down-e.noPrice);let g=`_diag_${e.asset}`,$=ec[g];if(!$||n-$.time>=15e3){ec[g]={reason:"diag",time:n};let t=Math.floor(e.secondsRemaining/60),a=e.secondsRemaining%60,s=(i/30).toFixed(1),o=(r/5).toFixed(1),c=u.direction>0?"UP":u.direction<0?"DN":"--",d=Y>0?Math.max(0,15-Math.round((n-Y)/1e3)):0;E(`[${e.asset}] ${t}:${a.toString().padStart(2,"0")} | BTC $${l.toFixed(0)} v30=$${s} v5=$${o} ${c}${(100*u.strength).toFixed(0)}% | UP $${e.yesPrice.toFixed(2)} fair $${f.up.toFixed(3)} | DN $${e.noPrice.toFixed(2)} fair $${f.down.toFixed(3)} | gap ${(100*X).toFixed(1)}c${d>0?` | CD ${d}s`:""}`)}if(s){let i="yes"===s.side?e.yesTokenId:e.noTokenId,r=Math.floor(p/s.actualPrice*100)/100,a=parseInt(e.slug.split("-").pop()||"0",10);if(t.paperTrading){let l=`scalp-paper-${Date.now()}`,c=Math.min(.99,Math.round((s.actualPrice+t.scalpProfitTarget)*100)/100);(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:s.side,action:"buy",price:s.actualPrice,amount:p,shares:r,pnl:null,paper:!0,orderId:l,asset:e.asset,subStrategy:"scalp",binancePriceAtEntry:(0,d.iS)(),slippage:null,takerFee:0}),V.push({id:l,conditionId:e.conditionId,slug:e.slug,asset:e.asset,side:s.side,tokenId:i,entryPrice:s.actualPrice,shares:r,costBasis:p,sellPrice:c,sellOrderId:null,buyOrderId:l,entryTime:n,windowEndTs:a}),H.set(e.conditionId,e.market),E(`[PAPER] Scalp entry: ${s.reason} | sell target $${c.toFixed(2)}`),A("info",`Scalp buy: ${s.side.toUpperCase()} @ $${s.actualPrice.toFixed(2)}`,e.asset)}else{E(`[LIVE] Attempting buy: ${s.side.toUpperCase()} ${r.toFixed(2)} @ $${s.actualPrice.toFixed(2)} | token=${i.slice(0,8)}...`);try{let l=await (0,c.L4)(i,s.actualPrice,r,e.tickSize,e.negRisk);if(l.success&&l.orderId){let c=l.filledPrice||s.actualPrice,u=l.filledSize||r,p=Math.min(.99,Math.round((c+t.scalpProfitTarget)*100)/100);V.push({id:l.orderId,conditionId:e.conditionId,slug:e.slug,asset:e.asset,side:s.side,tokenId:i,entryPrice:c,shares:u,costBasis:u*c,sellPrice:p,sellOrderId:null,buyOrderId:l.orderId,entryTime:n,windowEndTs:a}),H.set(e.conditionId,e.market),(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:s.side,action:"buy",price:c,amount:u*c,shares:u,pnl:null,paper:!1,orderId:l.orderId,asset:e.asset,subStrategy:"scalp",binancePriceAtEntry:(0,d.iS)(),slippage:c-s.actualPrice,takerFee:0}),E(`Market buy FILLED: ${s.side.toUpperCase()} ${u.toFixed(1)} @ $${c.toFixed(2)} | target $${p.toFixed(2)}`),A("info",`Scalp buy: ${s.side.toUpperCase()} @ $${c.toFixed(2)}`,e.asset)}else E(`Market buy FAILED: ${l.error||"unknown"} | ${s.side.toUpperCase()} ${r.toFixed(2)} @ $${s.actualPrice.toFixed(2)}`),A("warning",`Buy failed: ${l.error||"unknown"}`,e.asset)}catch(i){let t=i instanceof Error?i.message:String(i);E(`[LIVE] Buy exception: ${t}`),A("error",`Buy exception: ${t}`,e.asset)}}v=`Scalp signal: ${s.side.toUpperCase()} @ $${s.actualPrice.toFixed(2)}`,R=new Date().toISOString()}}}}if(t.valueEnabled&&z.filter(t=>t.conditionId===e.conditionId).length<t.valueMaxPositions&&T(t).available>=t.valueTradeSize){let i=(0,s.jc)(e.yesPrice,e.noPrice,l,e.secondsRemaining,t.valueMinGap,t.valueEntryMin,t.valueEntryMax,t.valueMaxSecondsRemaining,t.valueExitWindow,J);if(i){let r="yes"===i.side?e.yesTokenId:e.noTokenId,a=Math.floor(t.valueTradeSize/i.actualPrice*100)/100,s=parseInt(e.slug.split("-").pop()||"0",10);if(t.paperTrading){let l=`value-paper-${Date.now()}`,c=Math.min(.99,Math.round((i.actualPrice+t.valueProfitTarget)*100)/100);(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:i.side,action:"buy",price:i.actualPrice,amount:t.valueTradeSize,shares:a,pnl:null,paper:!0,orderId:l,asset:e.asset,subStrategy:"scalp",binancePriceAtEntry:(0,d.iS)(),slippage:null,takerFee:0}),z.push({id:l,conditionId:e.conditionId,slug:e.slug,asset:e.asset,side:i.side,tokenId:r,entryPrice:i.actualPrice,shares:a,costBasis:t.valueTradeSize,sellPrice:c,sellOrderId:null,buyOrderId:l,entryTime:n,windowEndTs:s}),H.set(e.conditionId,e.market),E(`[PAPER] ${i.reason}`),A("info",`Value buy: ${i.side.toUpperCase()} @ $${i.actualPrice.toFixed(2)}`,e.asset)}else{E(`[LIVE VALUE] Attempting: ${i.side.toUpperCase()} ${a.toFixed(2)} @ $${i.actualPrice.toFixed(2)}`);try{let l=await (0,c.L4)(r,i.actualPrice,a,e.tickSize,e.negRisk);if(l.success&&l.orderId){let c=l.filledPrice||i.actualPrice,u=l.filledSize||a,p=Math.min(.99,Math.round((c+t.valueProfitTarget)*100)/100);z.push({id:l.orderId,conditionId:e.conditionId,slug:e.slug,asset:e.asset,side:i.side,tokenId:r,entryPrice:c,shares:u,costBasis:u*c,sellPrice:p,sellOrderId:null,buyOrderId:l.orderId,entryTime:n,windowEndTs:s}),H.set(e.conditionId,e.market),(0,o.Ei)({timestamp:new Date().toISOString(),conditionId:e.conditionId,slug:e.slug,side:i.side,action:"buy",price:c,amount:u*c,shares:u,pnl:null,paper:!1,orderId:l.orderId,asset:e.asset,subStrategy:"scalp",binancePriceAtEntry:(0,d.iS)(),slippage:c-i.actualPrice,takerFee:0}),E(`[VALUE] FILLED: ${i.side.toUpperCase()} ${u.toFixed(1)} @ $${c.toFixed(2)}`),A("info",`Value buy: ${i.side.toUpperCase()} @ $${c.toFixed(2)}`,e.asset)}else E(`[VALUE] FAILED: ${l.error||"unknown"}`)}catch(t){let e=t instanceof Error?t.message:String(t);E(`[VALUE] Exception: ${e}`)}}}}}else{let e=ec._binance;if(!e||n-e.time>=15e3){ec._binance={reason:"no-coinbase",time:n};let e=(0,d.Ih)()>0?Math.round((n-(0,d.Ih)())/1e3):-1;E(`Waiting for Bitbo feed (last update: ${e>=0?e+"s ago":"never"})`)}}}for(let e=N.length-1;e>=0;e--){let t=N[e];if(!(n<t.nextAttempt)){t.attempts++;try{let i=await (0,c.fA)(t.conditionId,t.negRisk);i.success?(E(`${t.asset} winnings claimed on-chain (attempt ${t.attempts})`),A("success",`Claimed winnings for ${t.asset}`,t.asset),N.splice(e,1)):(g.k.info(`[Redeem] ${t.asset} attempt ${t.attempts}/20: ${i.error}`),t.attempts>=20?(A("warning",`Auto-claim failed for ${t.asset}`,t.asset),N.splice(e,1)):t.nextAttempt=n+3e4)}catch(i){g.k.error(`[Redeem] ${t.asset} attempt ${t.attempts} error: ${i}`),t.attempts>=20?N.splice(e,1):t.nextAttempt=n+3e4}}}}catch(e){g.k.error(`Trading loop error: ${e}`),E(`Error: ${e}`)}finally{ef=!1}P()}}async function F(){if("running"===O)return{success:!1,error:"Bot is already running"};g.k.info("Starting bot..."),O="running",v="Bot started",R=new Date().toISOString();let e=m();if(h(),(0,d.md)(),A("info",`Market scanner active for: ${e.enabledAssets.join(", ")}`),A("info","Binance BTC price feed connected"),e.paperTrading)ea=!1,A("info","Paper mode - CLOB client not needed");else{try{await (0,c.tS)()?(ea=!0,A("success","CLOB client ready for live trading")):(ea=!1,A("error","CLOB client failed - check PRIVATE_KEY and FUNDER_ADDRESS"))}catch{ea=!1,A("error","CLOB client initialization failed")}P()}if(!e.paperTrading)try{let e=await (0,c.A_)();if(e.length>0){let t=0;for(let i of e)!N.some(e=>e.conditionId===i.conditionId)&&(N.push({conditionId:i.conditionId,negRisk:i.negRisk,asset:"BTC",attempts:0,nextAttempt:Date.now()+5e3}),t++);t>0&&E(`Found ${t} claimable position(s) - queued for auto-claim`)}let t=(0,o.JU)(6);if(t.length>0){let{checkProxyTokenBalance:e}=await Promise.resolve().then(i.bind(i,21925)),n=0;for(let i of t)!N.some(e=>e.conditionId===i.conditionId)&&await e(i.conditionId)&&(N.push({conditionId:i.conditionId,negRisk:!0,asset:i.asset,attempts:0,nextAttempt:Date.now()+5e3}),n++);n>0&&E(`DB scan found ${n} additional claimable position(s)`)}0===N.length&&g.k.info("[Redeem] No unclaimed positions found")}catch(e){g.k.error(`[Redeem] Startup claim scan failed: ${e}`)}return x(),ee=setInterval(C,1e3),et=setInterval(x,3e4),P(),E("Bot started - Scalp strategy active"),A("success","Bot started successfully"),{success:!0}}function D(){if("stopped"===O)return{success:!1,error:"Bot is already stopped"};for(let e of(g.k.info("Stopping bot..."),ee&&(clearInterval(ee),ee=null),et&&(clearInterval(et),et=null),W))(0,c.sl)(e.orderId).catch(()=>{});for(let e of V)e.sellOrderId&&(0,c.sl)(e.sellOrderId).catch(()=>{});return W.length=0,O="stopped",ea=!1,S(),v="Bot stopped",R=new Date().toISOString(),P(),E("Bot stopped"),A("info","Bot stopped"),{success:!0}}function M(){return j=!1,q=null,Z=null,A("info","Circuit breaker manually reset"),P(),{success:!0}}n()}catch(e){n(e)}})},9854:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{S2:()=>l,XE:()=>o,vT:()=>s});var r=i(91162),a=e([r]);function s(e,t,i,n,a,s,o){let l=(0,r.ZV)(4e3);if(12>Math.abs(l))return{up:e,down:t};let c=4e-4*Math.abs(l);return l>0?{up:Math.min(.99,e+c),down:Math.max(.01,t-c)}:{up:Math.max(.01,e-c),down:Math.min(.99,t+c)}}function o(e,t,i,n,a,o,l,c,d,u,p,f,g,$){if(a<=0||c<=f)return null;let m=Date.now();if(g>0&&m-g<5e3)return null;let S=(0,r.ZV)(4e3);if(12>Math.abs(S))return null;let h=s(e,t,i,a,o,l,c),I=h.up-e,y=h.down-t,w=I>=d&&e>=u&&e<=p,k=y>=d&&t>=u&&t<=p;if(!w&&!k)return null;let P=`BTC ${S>0?"+":""}$${S.toFixed(0)} (4s)`;return w&&(!k||I>=y)?{side:"yes",fairValue:h.up,actualPrice:e,gap:I,reason:`[SCALP] ${P} | YES $${e.toFixed(2)} -> $${h.up.toFixed(2)} (+${(100*I).toFixed(1)}c)`}:k?{side:"no",fairValue:h.down,actualPrice:t,gap:y,reason:`[SCALP] ${P} | NO $${t.toFixed(2)} -> $${h.down.toFixed(2)} (+${(100*y).toFixed(1)}c)`}:null}function l(e,t,i,n,r,a,s,o=120){let l=i-e;return l>=s?{action:"sell_profit",sellPrice:i,reason:`[SCALP] TARGET: +${(100*l).toFixed(1)}c`}:a<=o?{action:l>=0?"sell_profit":"sell_loss",sellPrice:i,reason:`[SCALP] EXIT: ${l>=0?"+":""}${(100*l).toFixed(1)}c`}:{action:"hold",reason:`[SCALP] HOLD: ${l>=0?"+":""}${(100*l).toFixed(1)}c`}}r=(a.then?(await a)():a)[0],n()}catch(e){n(e)}})},95490:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{Px:()=>o,jc:()=>s});var r=i(91162),a=e([r]);function s(e,t,i,n,a,s,o,l,c,d){let u=(0,r.as)();if(i<=0||u<=0||n>l||n<=c)return null;let p=Date.now();if(d>0&&p-d<1e4)return null;let f=(i-u)/u*100,{side:g,gap:$,fairProb:m}=function(e,t,i){let n=Math.max(.02,Math.min(.98,1/(1+Math.exp(-(35*e))))),r=1-n,a=n-t,s=r-i;return a>s&&a>0?{side:"yes",gap:a,fairProb:n}:s>0?{side:"no",gap:s,fairProb:r}:{side:null,gap:0,fairProb:.5}}(f,e,t);if(null===g||$<a)return null;let S="yes"===g?e:t;if(S<s||S>o)return null;let h=f>=0?`+${f.toFixed(3)}%`:`${f.toFixed(3)}%`,I=`${Math.floor(n/60)}:${(n%60).toString().padStart(2,"0")}`;return{side:g,fairValue:m,actualPrice:S,gap:$,reason:`[VALUE] BTC ${h} | ${g.toUpperCase()} $${S.toFixed(2)} -> fair $${m.toFixed(2)} (+${(100*$).toFixed(1)}c) | ${I} left`}}function o(e,t,i,n,r,a,s){let o=t-e;return o>=a?{action:"sell_profit",sellPrice:t,reason:`[VALUE] TARGET: +${(100*o).toFixed(1)}c`}:r<=30&&Math.abs(i)>=.02&&n===(i>=0?"yes":"no")?{action:"hold_resolution",reason:`[VALUE] HOLD FOR WIN: ${i>=0?"+":""}${i.toFixed(3)}%`}:r<=s?{action:o>=0?"sell_profit":"sell_loss",sellPrice:t,reason:`[VALUE] EXIT: ${o>=0?"+":""}${(100*o).toFixed(1)}c`}:{action:"hold",reason:`[VALUE] HOLD: ${o>=0?"+":""}${(100*o).toFixed(1)}c`}}r=(a.then?(await a)():a)[0],n()}catch(e){n(e)}})},97320:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{P_:()=>m,pi:()=>u,pw:()=>S,r_:()=>$,ri:()=>f});var r=i(35240),a=i.n(r),s=i(67332),o=i(21925),l=i(43895),c=e([s,o]);async function d(e,t,i=3){for(let n=0;n<i;n++)try{return await function(e,t){let i=new URLSearchParams(t).toString(),n=`${e}?${i}`;return new Promise((e,t)=>{let i=a().get({hostname:"gamma-api.polymarket.com",path:n,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Language":"en-US,en;q=0.9"},ciphers:"TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA:AES256-SHA",ecdhCurve:"prime256v1:secp384r1",minVersion:"TLSv1.2",maxVersion:"TLSv1.3",timeout:1e4},i=>{if(i.statusCode&&i.statusCode>=400){let e=Error(`${i.statusCode} ${i.statusMessage}`);e.status=i.statusCode,i.resume(),t(e);return}let n="";i.on("data",e=>n+=e),i.on("end",()=>{try{e(JSON.parse(n))}catch(e){t(e)}})});i.on("error",t),i.on("timeout",()=>{i.destroy(),t(Error("timeout"))})})}(e,t)}catch(s){if(n===i-1)throw s;let r=s.status;if(r&&r>=400&&r<500&&429!==r)throw s;let a=Math.min(1e3*Math.pow(2,n),8e3);l.k.warn(`[Markets] ${e}?${new URLSearchParams(t)} failed (attempt ${n+1}/${i}), retrying in ${a}ms`),await new Promise(e=>setTimeout(e,a))}throw Error("Unreachable")}function u(){let e=Math.floor(Date.now()/1e3);return(Math.floor(e/900)+1)*900-e}async function p(e){try{let t=await d("/markets",{slug:e});if(!t||!Array.isArray(t)||0===t.length)return l.k.debug(`No market found for slug: ${e}`),null;let i=t[0],n=i.clobTokenIds?"string"==typeof i.clobTokenIds?JSON.parse(i.clobTokenIds):i.clobTokenIds:[];if(n.length<2)return l.k.warn(`Market ${e} has insufficient token IDs`),null;return{conditionId:i.conditionId,slug:i.slug||e,question:i.question||"BTC 15m candle",yesTokenId:n[0],noTokenId:n[1],endDate:i.endDate||i.endDateIso||"",endTimestamp:i.endDate?new Date(i.endDate).getTime()/1e3:0,active:!1!==i.active&&!i.closed,tickSize:i.orderPriceMinTickSize||"0.01",negRisk:!0===i.negRisk}}catch(t){if(404===t.status)return null;return l.k.error(`Error fetching market ${e}: ${t.message||t}`),null}}async function f(){let e=function(){let e=Math.floor(Date.now()/1e3);return`btc-updown-15m-${900*Math.floor(e/900)}`}(),t=await p(e);if(t&&t.active)return t;let i=Math.floor(Date.now()/1e3),n=`btc-updown-15m-${(Math.floor(i/900)-1)*900}`;return(t=await p(n))&&t.active?t:null}async function g(e){try{let t=(0,o.YX)(),[i,n]=await Promise.all([t.getOrderBook(e.yesTokenId).catch(()=>null),t.getOrderBook(e.noTokenId).catch(()=>null)]),r=.5,a=.5;i&&(i.asks&&i.asks.length>0?r=parseFloat(i.asks[0].price):i.last_trade_price&&(r=parseFloat(i.last_trade_price))),n&&(n.asks&&n.asks.length>0?a=parseFloat(n.asks[0].price):n.last_trade_price&&(a=parseFloat(n.last_trade_price))),r>0&&.5===a?a=Math.max(.01,1-r):a>0&&.5===r&&(r=Math.max(.01,1-a));let s=r>=a?"yes":"no",l="yes"===s?r:a;return{yesPrice:r,noPrice:a,leadingSide:s,leadingPrice:l,timestamp:Date.now()}}catch(e){return l.k.error(`Error fetching prices: ${e}`),null}}async function $(e){try{let t=await d("/markets",{slug:e});if(!t||!Array.isArray(t)||0===t.length)return l.k.debug(`[Resolution] No market found for slug: ${e}`),null;let i=t[0];if(!0===i.active&&!i.closed)return l.k.debug(`[Resolution] ${e} still active (active=${i.active}, closed=${i.closed})`),null;if(i.outcomePrices){let t;if("string"==typeof i.outcomePrices)try{let e=JSON.parse(i.outcomePrices);t=Array.isArray(e)?e.map(Number):i.outcomePrices.split(",").map(Number)}catch{t=i.outcomePrices.split(",").map(Number)}else{if(!Array.isArray(i.outcomePrices))return l.k.debug(`[Resolution] ${e} unexpected outcomePrices type: ${typeof i.outcomePrices}`),null;t=i.outcomePrices.map(Number)}if(t.length>=2&&!t.some(isNaN)){if(t[0]>t[1])return l.k.info(`[Resolution] ${e} resolved YES/UP (prices: ${t})`),"yes";if(t[1]>t[0])return l.k.info(`[Resolution] ${e} resolved NO/DOWN (prices: ${t})`),"no"}l.k.debug(`[Resolution] ${e} outcomePrices inconclusive: ${JSON.stringify(t)}`)}else l.k.debug(`[Resolution] ${e} closed but no outcomePrices (active=${i.active}, closed=${i.closed})`);return null}catch(t){return l.k.error(`[Resolution] Failed to fetch ${e}: ${t}`),null}}async function m(e){try{let t=(0,o.YX)(),i=await t.getMidpoints([{token_id:e.yesTokenId,side:s.Side.BUY},{token_id:e.noTokenId,side:s.Side.BUY}]),n=parseFloat(i?.[e.yesTokenId]||"0"),r=parseFloat(i?.[e.noTokenId]||"0");if(l.k.debug(`[Resolution CLOB] ${e.slug} YES=${n} NO=${r}`),n>.9)return"yes";if(r>.9)return"no";return null}catch(t){return l.k.debug(`[Resolution CLOB] Failed for ${e.slug}: ${t}`),null}}async function S(e){try{let t=(0,o.YX)(),i=await t.getMidpoints([{token_id:e.yesTokenId,side:s.Side.BUY},{token_id:e.noTokenId,side:s.Side.BUY}]),n=parseFloat(i?.[e.yesTokenId]||"0.5"),r=parseFloat(i?.[e.noTokenId]||"0.5"),a=n>=r?"yes":"no";return{yesPrice:n,noPrice:r,leadingSide:a,leadingPrice:"yes"===a?n:r,timestamp:Date.now()}}catch{return g(e)}}[s,o]=c.then?(await c)():c,n()}catch(e){n(e)}})},91162:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{Ih:()=>p,VI:()=>S,ZV:()=>m,as:()=>f,cs:()=>$,iS:()=>u,md:()=>d,zk:()=>g});var r=i(89814),a=i(43895),s=e([r]);r=(s.then?(await s)():s)[0];let h=null,I=null,y=0,w=0,k=0,P=0,E=!1,A=[],T=[];function o(){return 900*Math.floor(Date.now()/1e3/900)}function l(){if(h){try{h.close()}catch{}h=null}try{h=new r.default("wss://api.bitbo.io",{headers:{Origin:"https://bitbo.io"}})}catch(e){a.k.error(`[BitboWS] Failed to create WebSocket: ${e}`),c();return}h.on("open",()=>{a.k.info("[BitboWS] Connected to Bitbo price stream")}),h.on("message",e=>{try{let t=JSON.parse(e.toString());t.market&&"number"==typeof t.market.p&&function(e){if(e<=0)return;y=e,w=Date.now();let t=Date.now();if(0===A.length||t-A[A.length-1].ts>=500)for(A.push({price:e,ts:t});A.length>0&&t-A[0].ts>6e4;)A.shift();if(0===T.length||t-T[T.length-1].ts>=1e4)for(T.push({price:e,ts:t});T.length>0&&t-T[0].ts>54e5;)T.shift();let i=o();i!==P&&(k=e,P=i,a.k.info(`[BitboWS] New window ${i}: open $${e.toFixed(2)} (Bitbo)`))}(t.market.p)}catch{}}),h.on("close",()=>{a.k.warn("[BitboWS] Disconnected"),E&&c()}),h.on("error",e=>{a.k.error(`[BitboWS] Error: ${e.message}`)})}function c(){I||(I=setTimeout(()=>{I=null,E&&l()},3e3))}function d(){E||(E=!0,l())}function u(){return y}function p(){return w}function f(){let e=o();return P!==e&&y>0&&(k=y,P=e,a.k.info(`[BitboWS] Mid-window start ${e}: using current price $${y.toFixed(2)} as open`)),k}function g(){let e=f();return e<=0||y<=0?0:(y-e)/e}function $(){return w>0&&Date.now()-w<1e4}function m(e=1e4){if(A.length<2)return 0;let t=Date.now()-e,i=null;for(let e of A)if(e.ts>=t){i=e;break}return!i||i.price<=0?0:y-i.price}function S(e=18e5){let t={delta:0,pctChange:0,direction:0,strength:0};if(T.length<3)return t;let i=Date.now()-e,n=null;for(let e of T)if(e.ts>=i){n=e;break}if(!n||n.price<=0)return t;let r=y-n.price,a=r/n.price,s=r>0?1:r<0?-1:0,o=(n.price+y)/2,l=0,c=0;for(let e of T)!(e.ts<i)&&(c++,s>0&&e.price>=o?l++:s<0&&e.price<=o?l++:0===s&&l++);let d=c>0?l/c:0;return{delta:r,pctChange:a,direction:s,strength:d}}n()}catch(e){n(e)}})},24979:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.d(t,{$2:()=>y,E3:()=>I,bp:()=>S,rs:()=>w,up:()=>h});var r=i(35240),a=i.n(r),s=i(21925),o=i(43895),l=i(67332),c=e([s,l]);async function d(e,t,i=3){for(let n=0;n<i;n++)try{return await function(e,t){let i=new URLSearchParams(t).toString(),n=`${e}?${i}`;return new Promise((e,t)=>{let i=a().get({hostname:"gamma-api.polymarket.com",path:n,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36",Accept:"application/json, text/plain, */*","Accept-Language":"en-US,en;q=0.9"},ciphers:"TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA:AES256-SHA",ecdhCurve:"prime256v1:secp384r1",minVersion:"TLSv1.2",maxVersion:"TLSv1.3",timeout:1e4},i=>{if(i.statusCode&&i.statusCode>=400){let e=Error(`${i.statusCode} ${i.statusMessage}`);e.status=i.statusCode,i.resume(),t(e);return}let n="";i.on("data",e=>n+=e),i.on("end",()=>{try{e(JSON.parse(n))}catch(e){t(e)}})});i.on("error",t),i.on("timeout",()=>{i.destroy(),t(Error("timeout"))})})}(e,t)}catch(s){if(n===i-1)throw s;let r=s.status;if(r&&r>=400&&r<500&&429!==r)throw s;let a=Math.min(1e3*Math.pow(2,n),8e3);o.k.warn(`[Scanner] ${e}?${new URLSearchParams(t)} failed (attempt ${n+1}/${i}), retrying in ${a}ms`),await new Promise(e=>setTimeout(e,a))}throw Error("Unreachable")}[s,l]=c.then?(await c)():c;let k={BTC:"btc",ETH:"eth",SOL:"sol",XRP:"xrp"},P=new Map,E=new Map,A=new Map,T=0,b=[];function u(e){let t=Math.floor(Date.now()/1e3);return Math.max(0,e+900-t)}async function p(e,t){let i=`${k[e]}-updown-15m-${t}`;try{let n=await d("/markets",{slug:i});if(!n||!Array.isArray(n)||0===n.length)return null;let r=n[0],a=r.clobTokenIds?"string"==typeof r.clobTokenIds?JSON.parse(r.clobTokenIds):r.clobTokenIds:[];if(a.length<2)return null;return{conditionId:r.conditionId,slug:r.slug||i,question:r.question||`${e} 15m candle`,yesTokenId:a[0],noTokenId:a[1],endDate:r.endDate||r.endDateIso||"",endTimestamp:r.endDate?new Date(r.endDate).getTime()/1e3:t+900,active:!1!==r.active&&!r.closed,tickSize:r.orderPriceMinTickSize||"0.01",negRisk:!0===r.negRisk,asset:e}}catch(i){return o.k.error(`[Scanner] fetchMarket(${e}, ${t}) failed: ${i.message||i}`),null}}async function f(e){let{current:t,prev:i}=function(){let e=Math.floor(Date.now()/1e3),t=900*Math.floor(e/900);return{current:t,prev:t-900}}();await Promise.all(e.map(async e=>{let n=E.get(e);if(!n||n.windowTs!==t)for(let n of[t,i]){let i=await p(e,n);if(i&&i.active){E.set(e,{market:i,windowTs:t});break}}})),await g(e);let n=Date.now(),r=JSON.stringify(e)!==JSON.stringify(b);(n-T>5e3||r)&&(T=n,b=[...e],$(e).catch(()=>{}))}async function g(e){let t=[],i=[];for(let n of e){let e=E.get(n);if(!e)continue;let{market:r}=e;r.active&&(0>=u(parseInt(r.slug.split("-").pop()||"0",10))||(t.push({asset:n,market:r}),i.push({token_id:r.yesTokenId,side:l.Side.BUY},{token_id:r.noTokenId,side:l.Side.BUY})))}if(0!==i.length)try{let e=(0,s.YX)(),n=await e.getMidpoints(i);for(let{asset:e,market:i}of t){let t=parseFloat(n?.[i.yesTokenId]||"0.5"),r=parseFloat(n?.[i.noTokenId]||"0.5"),a=parseInt(i.slug.split("-").pop()||"0",10),s=u(a);if(s>0){let n={asset:e,conditionId:i.conditionId,slug:i.slug,yesTokenId:i.yesTokenId,noTokenId:i.noTokenId,yesPrice:t,noPrice:r,combinedCost:t+r,secondsRemaining:s,market:i,tickSize:i.tickSize,negRisk:i.negRisk};P.set(e,n)}}}catch(t){let e=t instanceof Error?t.message:String(t);o.k.warn(`[Scanner] Batched price poll failed: ${e}`)}}async function $(e){let t=Math.floor(Date.now()/1e3),i=900*Math.floor(t/900),n=[];for(let t of e){let e=k[t];for(let t=1;t<=10;t++){let r=i-900*t,a=`${e}-updown-15m-${r}`,s=A.get(a);s&&"pending"!==s.result||n.push((async()=>{try{let e=await m(a),t=new Date((r+900)*1e3);A.set(a,{slug:a,timestamp:r,result:e,endTime:t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})})}catch{}})())}}await Promise.all(n)}async function m(e){try{let t=await d("/markets",{slug:e},2);if(!t?.[0])return"pending";let i=t[0];if(!0===i.active&&!i.closed)return"pending";if(i.outcomePrices)try{let e;if("string"==typeof i.outcomePrices)try{let t=JSON.parse(i.outcomePrices);e=Array.isArray(t)?t.map(Number):i.outcomePrices.split(",").map(Number)}catch{e=i.outcomePrices.split(",").map(Number)}else e=Array.isArray(i.outcomePrices)?i.outcomePrices.map(Number):[];if(e.length>=2&&!e.some(isNaN)){if(e[0]>e[1])return"up";if(e[1]>e[0])return"down"}}catch{}let n=i.clobTokenIds?"string"==typeof i.clobTokenIds?JSON.parse(i.clobTokenIds):i.clobTokenIds:[];if(n.length>=2)try{let e=(0,s.YX)(),t=await e.getMidpoints([{token_id:n[0],side:l.Side.BUY},{token_id:n[1],side:l.Side.BUY}]),i=parseFloat(t?.[n[0]]||"0"),r=parseFloat(t?.[n[1]]||"0");if(i>.9)return"up";if(r>.9)return"down"}catch{}return"pending"}catch{return"pending"}}function S(e){let t=Math.floor(Date.now()/1e3),i=900*Math.floor(t/900),n=[],r=e&&e.length>0?e.map(e=>k[e]):Object.values(k);for(let e=1;e<=10;e++){let t=i-900*e;for(let e of r){let i=`${e}-updown-15m-${t}`,r=A.get(i);if(r){n.push(r);break}}}return n}function h(e){f(e).catch(e=>{o.k.error(`[Scanner] Initial scan failed: ${e}`)}),setInterval(()=>{f(e).catch(e=>{o.k.error(`[Scanner] Scan failed: ${e}`)})},3e4),setInterval(()=>{g(e).catch(e=>{o.k.error(`[Scanner] Price poll failed: ${e}`)})},1e3),o.k.info(`[Scanner] Started for assets: ${e.join(", ")}`)}function I(e,t){let i=A.get(e);if(i)i.result=t;else{let i=parseInt(e.split("-").pop()||"0",10),n=new Date((i+900)*1e3);A.set(e,{slug:e,timestamp:i,result:t,endTime:n.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})})}}function y(){let e=Math.floor(Date.now()/1e3);return Array.from(P.values()).map(t=>{let i=parseInt(t.slug.split("-").pop()||"0",10);return{...t,secondsRemaining:Math.max(0,i+900-e)}})}function w(e){return P.get(e)||null}n()}catch(e){n(e)}})}};